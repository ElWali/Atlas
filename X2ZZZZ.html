<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, user-scalable=no">
    <meta name="description" content="LiteMap - Lightweight JavaScript Mapping Library">
    <meta name="theme-color" content="#2c3e50">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>LiteMap v1.0.0 - Interactive Map</title>
    
    <style>
        /****************************
         * CSS RESET & BASE
         ****************************/
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        html, body {
            width: 100%;
            height: 100%;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #1a1a1a;
            color: #333;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            overscroll-behavior: none;
            position: fixed;
            overflow: hidden;
        }

        /****************************
         * MAP CONTAINER
         ****************************/
        .litemap-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .litemap-canvas {
            position: absolute;
            top: 0;
            left: 0;
            display: block;
            touch-action: none;
            image-rendering: pixelated;
            will-change: transform;
        }

        /****************************
         * CONTROLS STYLING
         ****************************/
        .litemap-controls {
            position: absolute;
            z-index: 1000;
            font-size: 14px;
            font-weight: 500;
            pointer-events: auto;
        }

        /* Logo */
        .litemap-logo {
            top: 12px;
            left: 12px;
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 14px;
            background: rgba(255, 255, 255, 0.98);
            border-radius: 8px;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.15);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }

        .litemap-logo-icon {
            width: 24px;
            height: 24px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 12px;
            flex-shrink: 0;
        }

        .litemap-logo-text {
            font-weight: 700;
            color: #2c3e50;
            letter-spacing: -0.5px;
        }

        .litemap-logo-version {
            font-size: 10px;
            color: #95a5a6;
            margin-left: 4px;
        }

        /* Toolbar */
        .litemap-toolbar {
            top: 12px;
            right: 12px;
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .litemap-control-group {
            display: flex;
            flex-direction: column;
            gap: 0;
            background: rgba(255, 255, 255, 0.98);
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.15);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }

        .litemap-button {
            width: 44px;
            height: 44px;
            border: none;
            background: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            color: #667eea;
            font-size: 18px;
            font-weight: bold;
            border-bottom: 1px solid #ecf0f1;
            flex-shrink: 0;
            user-select: none;
            -webkit-user-select: none;
        }

        .litemap-button:last-child {
            border-bottom: none;
        }

        .litemap-button:hover:not(:disabled) {
            background: #f8f9ff;
            transform: scale(1.05);
        }

        .litemap-button:active:not(:disabled) {
            background: #f0f2ff;
            transform: scale(0.95);
        }

        .litemap-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            color: #bdc3c7;
        }

        .litemap-button:focus-visible {
            outline: 2px solid #667eea;
            outline-offset: 2px;
        }

        /* Layers Panel */
        .litemap-layers {
            bottom: 12px;
            left: 12px;
            background: rgba(255, 255, 255, 0.98);
            border-radius: 8px;
            padding: 12px;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.15);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            min-width: 200px;
            max-width: 280px;
            max-height: 60vh;
            overflow-y: auto;
        }

        .litemap-layers::-webkit-scrollbar {
            width: 6px;
        }

        .litemap-layers::-webkit-scrollbar-track {
            background: transparent;
        }

        .litemap-layers::-webkit-scrollbar-thumb {
            background: #ddd;
            border-radius: 3px;
        }

        .litemap-layers-title {
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .litemap-layers-title::before {
            content: '';
            width: 4px;
            height: 4px;
            background: #667eea;
            border-radius: 50%;
        }

        .litemap-layer-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px;
            margin: 4px 0;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.15s ease;
            user-select: none;
            -webkit-user-select: none;
        }

        .litemap-layer-item:hover {
            background: #f8f9ff;
        }

        .litemap-layer-toggle {
            width: 18px;
            height: 18px;
            border: 2px solid #ddd;
            border-radius: 3px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            flex-shrink: 0;
            background: white;
        }

        .litemap-layer-toggle:focus-visible {
            outline: 2px solid #667eea;
        }

        .litemap-layer-toggle.active {
            background: #667eea;
            border-color: #667eea;
            color: white;
        }

        .litemap-layer-toggle.active::after {
            content: '✓';
            font-size: 12px;
            font-weight: bold;
        }

        .litemap-layer-label {
            flex: 1;
            font-size: 13px;
            color: #555;
            font-weight: 500;
        }

        .litemap-layer-opacity {
            width: 60px;
            height: 20px;
            cursor: pointer;
            accent-color: #667eea;
        }

        /* Info Panel */
        .litemap-info {
            bottom: 12px;
            right: 12px;
            background: rgba(255, 255, 255, 0.98);
            border-radius: 8px;
            padding: 12px 14px;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.15);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            font-size: 12px;
            min-width: 180px;
            max-width: 280px;
        }

        .litemap-info-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 4px 0;
            color: #666;
        }

        .litemap-info-label {
            font-weight: 600;
            color: #2c3e50;
        }

        .litemap-info-value {
            color: #667eea;
            font-weight: 600;
            font-family: 'Monaco', 'Courier New', monospace;
            font-size: 11px;
        }

        .litemap-info-separator {
            height: 1px;
            background: #ecf0f1;
            margin: 6px 0;
        }

        /****************************
         * POPUPS
         ****************************/
        .litemap-popup {
            position: fixed;
            background: rgba(255, 255, 255, 0.99);
            border-radius: 8px;
            padding: 12px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2);
            min-width: 160px;
            max-width: 280px;
            z-index: 999;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            animation: popupIn 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }

        @keyframes popupIn {
            from {
                opacity: 0;
                transform: scale(0.8);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .litemap-popup-title {
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 6px;
            font-size: 14px;
        }

        .litemap-popup-content {
            font-size: 12px;
            color: #666;
            line-height: 1.4;
        }

        .litemap-popup-close {
            position: absolute;
            top: 4px;
            right: 4px;
            width: 24px;
            height: 24px;
            background: transparent;
            border: none;
            cursor: pointer;
            color: #bdc3c7;
            font-size: 16px;
            transition: color 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
        }

        .litemap-popup-close:hover {
            color: #e74c3c;
        }

        /****************************
         * MARKERS
         ****************************/
        .litemap-marker {
            position: fixed;
            width: 32px;
            height: 40px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 50% 50% 50% 0;
            transform: translate(-50%, -100%);
            cursor: pointer;
            box-shadow: 0 3px 12px rgba(102, 126, 234, 0.4);
            border: 3px solid white;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            will-change: transform;
            z-index: 100;
        }

        .litemap-marker:hover {
            transform: translate(-50%, -100%) scale(1.15);
            box-shadow: 0 4px 16px rgba(102, 126, 234, 0.6);
        }

        .litemap-marker.active {
            background: linear-gradient(135deg, #764ba2 0%, #667eea 100%);
        }

        /****************************
         * RESPONSIVE
         ****************************/
        @media (max-width: 768px) {
            .litemap-logo {
                top: 8px;
                left: 8px;
                padding: 8px 12px;
                font-size: 12px;
            }

            .litemap-logo-version {
                display: none;
            }

            .litemap-toolbar {
                top: 8px;
                right: 8px;
            }

            .litemap-button {
                width: 40px;
                height: 40px;
            }

            .litemap-layers {
                bottom: 8px;
                left: 8px;
                max-width: 220px;
                padding: 10px;
            }

            .litemap-info {
                bottom: 8px;
                right: 8px;
                font-size: 11px;
                padding: 10px 12px;
            }
        }

        @media (max-width: 480px) {
            .litemap-logo {
                top: 6px;
                left: 6px;
                padding: 6px 10px;
                gap: 6px;
            }

            .litemap-logo-icon {
                width: 20px;
                height: 20px;
                font-size: 10px;
            }

            .litemap-layers {
                max-width: 180px;
                bottom: 6px;
                left: 6px;
            }

            .litemap-info {
                bottom: 6px;
                right: 6px;
                min-width: 160px;
            }

            .litemap-toolbar {
                top: 6px;
                right: 6px;
                gap: 4px;
            }

            .litemap-button {
                width: 36px;
                height: 36px;
                font-size: 16px;
            }
        }

        /****************************
         * DARK MODE
         ****************************/
        @media (prefers-color-scheme: dark) {
            .litemap-container {
                background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            }

            .litemap-logo,
            .litemap-button,
            .litemap-layers,
            .litemap-info,
            .litemap-popup {
                background: rgba(40, 40, 50, 0.98);
                color: #e0e0e0;
            }

            .litemap-logo-text {
                color: #e0e0e0;
            }

            .litemap-button {
                background: #2d2d3d;
                color: #667eea;
                border-bottom-color: #444;
            }

            .litemap-button:hover:not(:disabled) {
                background: #3a3a4d;
            }

            .litemap-layer-label,
            .litemap-popup-content {
                color: #b0b0b0;
            }

            .litemap-layer-toggle {
                background: #3a3a4d;
                border-color: #555;
            }

            .litemap-info-label {
                color: #e0e0e0;
            }
        }

        /****************************
         * ACCESSIBILITY
         ****************************/
        @media (prefers-reduced-motion: reduce) {
            .litemap-marker,
            .litemap-button,
            .litemap-popup {
                animation: none !important;
                transition: none !important;
            }
        }

        @media (hover: none) {
            .litemap-button:hover {
                transform: none;
            }
        }
    </style>
</head>
<body>
    <div class="litemap-container" id="liteMapContainer">
        <!-- Logo -->
        <div class="litemap-controls litemap-logo">
            <div class="litemap-logo-icon">🗺️</div>
            <div>
                <div class="litemap-logo-text">LiteMap</div>
                <div class="litemap-logo-version">v1.0.0</div>
            </div>
        </div>

        <!-- Toolbar -->
        <div class="litemap-controls litemap-toolbar">
            <div class="litemap-control-group">
                <button class="litemap-button" id="zoomInBtn" title="Zoom In" aria-label="Zoom In">+</button>
                <button class="litemap-button" id="zoomOutBtn" title="Zoom Out" aria-label="Zoom Out">−</button>
            </div>
            <div class="litemap-control-group">
                <button class="litemap-button" id="resetBtn" title="Reset View" aria-label="Reset View">⊙</button>
                <button class="litemap-button" id="fullscreenBtn" title="Toggle Fullscreen" aria-label="Toggle Fullscreen">⛶</button>
            </div>
        </div>

        <!-- Layers Panel -->
        <div class="litemap-controls litemap-layers">
            <div class="litemap-layers-title">Layers</div>
            <div id="layerControls"></div>
        </div>

        <!-- Info Panel -->
        <div class="litemap-controls litemap-info">
            <div class="litemap-info-row">
                <span class="litemap-info-label">Zoom:</span>
                <span class="litemap-info-value" id="zoomLevel">13</span>
            </div>
            <div class="litemap-info-row">
                <span class="litemap-info-label">Center:</span>
                <span class="litemap-info-value" id="centerCoords">0°, 0°</span>
            </div>
            <div class="litemap-info-separator"></div>
            <div class="litemap-info-row">
                <span class="litemap-info-label">Markers:</span>
                <span class="litemap-info-value" id="markerCount">0</span>
            </div>
            <div class="litemap-info-row">
                <span class="litemap-info-label">FPS:</span>
                <span class="litemap-info-value" id="fpsCounter">60</span>
            </div>
        </div>
    </div>

    <script>
        /**
         * LiteMap v1.0.0 - Production-Ready Single-File Mapping Library
         * ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
         * 
         * Features:
         * ✓ Zero dependencies
         * ✓ Canvas-based rendering (high performance)
         * ✓ Touch gesture support (iOS/Android)
         * ✓ Multi-layer system with opacity control
         * ✓ Marker management with popups
         * ✓ Responsive design
         * ✓ Accessibility compliant
         * ✓ Dark mode support
         * ✓ Memory efficient
         * ✓ Production-tested
         */

        class LiteMapCore {
            constructor(containerId, options = {}) {
                try {
                    // Configuration
                    this.config = {
                        center: { lat: 51.5074, lng: -0.1278 },
                        zoom: 13,
                        minZoom: 2,
                        maxZoom: 20,
                        pitch: 0,
                        bearing: 0,
                        animationDuration: 300,
                        renderQuality: window.devicePixelRatio,
                        maxMarkers: 10000,
                        enableDebug: false,
                        ...options
                    };

                    // Container
                    this.container = document.getElementById(containerId);
                    if (!this.container) {
                        throw new Error(`Container #${containerId} not found`);
                    }

                    // State
                    this.state = {
                        center: { ...this.config.center },
                        zoom: this.config.zoom,
                        isDragging: false,
                        dragStart: null,
                        isAnimating: false,
                        lastRenderTime: 0
                    };

                    // Data storage
                    this.layers = new Map();
                    this.markers = new Map();
                    this.popups = new Map();
                    this.visibleMarkers = new Set();

                    // Performance
                    this.performance = {
                        fps: 60,
                        frameCount: 0,
                        lastFrameTime: Date.now(),
                        renderTime: 0,
                        isLowEndDevice: this.detectLowEndDevice()
                    };

                    // Canvas
                    this.canvas = null;
                    this.ctx = null;

                    // Animation frame ID for cleanup
                    this.animationFrameId = null;
                    this.renderLoopRunning = false;

                    // Initialize
                    this.init();

                } catch (error) {
                    console.error('[LiteMap] Initialization failed:', error);
                    throw error;
                }
            }

            /**
             * Initialize map
             */
            init() {
                try {
                    this.setupCanvas();
                    this.setupEventListeners();
                    this.loadDefaultLayers();
                    this.addDefaultMarkers();
                    this.startRenderLoop();
                    this.log('✓ Map initialized successfully');
                } catch (error) {
                    this.error('Initialization failed', error);
                    throw error;
                }
            }

            /**
             * Setup canvas
             */
            setupCanvas() {
                // Clean up old canvas
                const existing = this.container.querySelector('canvas');
                if (existing) existing.remove();

                // Create canvas
                this.canvas = document.createElement('canvas');
                this.canvas.className = 'litemap-canvas';
                this.canvas.width = this.container.offsetWidth * this.config.renderQuality;
                this.canvas.height = this.container.offsetHeight * this.config.renderQuality;
                this.container.insertBefore(this.canvas, this.container.firstChild);

                // Get context
                this.ctx = this.canvas.getContext('2d', {
                    alpha: true,
                    antialias: true,
                    preserveDrawingBuffer: false,
                    willReadFrequently: false
                });

                if (!this.ctx) {
                    throw new Error('Failed to get canvas context');
                }

                // Scale for high DPI
                this.ctx.scale(this.config.renderQuality, this.config.renderQuality);

                this.log(`Canvas created: ${this.canvas.width}x${this.canvas.height}`);
            }

            /**
             * Setup event listeners
             */
            setupEventListeners() {
                // Mouse events
                this.canvas.addEventListener('mousedown', e => this.handleMouseDown(e));
                this.canvas.addEventListener('mousemove', e => this.handleMouseMove(e));
                document.addEventListener('mouseup', e => this.handleMouseUp(e));
                this.canvas.addEventListener('wheel', e => this.handleWheel(e), { passive: false });
                this.canvas.addEventListener('dblclick', e => this.handleDoubleClick(e));
                this.canvas.addEventListener('click', e => this.handleClick(e));

                // Touch events
                this.canvas.addEventListener('touchstart', e => this.handleTouchStart(e), { passive: true });
                this.canvas.addEventListener('touchmove', e => this.handleTouchMove(e), { passive: false });
                this.canvas.addEventListener('touchend', e => this.handleTouchEnd(e), { passive: true });

                // Window events
                window.addEventListener('resize', () => this.handleResize());
                window.addEventListener('orientationchange', () => this.handleOrientationChange());

                // UI Controls
                this.attachUIHandlers();

                this.log('Event listeners attached');
            }

            /**
             * Attach UI button handlers
             */
            attachUIHandlers() {
                const handlers = {
                    'zoomInBtn': () => this.zoomIn(),
                    'zoomOutBtn': () => this.zoomOut(),
                    'resetBtn': () => this.reset(),
                    'fullscreenBtn': () => this.toggleFullscreen()
                };

                for (const [id, handler] of Object.entries(handlers)) {
                    const btn = document.getElementById(id);
                    if (btn) {
                        btn.addEventListener('click', handler);
                    }
                }
            }

            /**
             * Touch event handlers
             */
            handleTouchStart(e) {
                if (e.touches.length === 1) {
                    this.state.isDragging = true;
                    this.state.dragStart = {
                        x: e.touches[0].clientX,
                        y: e.touches[0].clientY
                    };
                    this.touchStartZoom = this.state.zoom;
                } else if (e.touches.length === 2) {
                    e.preventDefault();
                    this.touchStartDistance = this.getTouchDistance(e.touches[0], e.touches[1]);
                    this.touchStartZoom = this.state.zoom;
                }
            }

            handleTouchMove(e) {
                if (e.touches.length === 1 && this.state.isDragging) {
                    this.handlePan(e.touches[0].clientX, e.touches[0].clientY);
                } else if (e.touches.length === 2) {
                    e.preventDefault();
                    const distance = this.getTouchDistance(e.touches[0], e.touches[1]);
                    const zoomDelta = (distance - this.touchStartDistance) / 100;
                    this.setZoom(this.touchStartZoom + zoomDelta);
                }
            }

            handleTouchEnd(e) {
                this.state.isDragging = false;
                this.touchStartDistance = null;
            }

            getTouchDistance(t1, t2) {
                const dx = t1.clientX - t2.clientX;
                const dy = t1.clientY - t2.clientY;
                return Math.sqrt(dx * dx + dy * dy);
            }

            /**
             * Mouse event handlers
             */
            handleMouseDown(e) {
                this.state.isDragging = true;
                this.state.dragStart = { x: e.clientX, y: e.clientY };
            }

            handleMouseMove(e) {
                if (this.state.isDragging && this.state.dragStart) {
                    this.handlePan(e.clientX, e.clientY);
                }
            }

            handleMouseUp(e) {
                this.state.isDragging = false;
            }

            handlePan(currentX, currentY) {
                if (!this.state.dragStart) return;

                const deltaX = currentX - this.state.dragStart.x;
                const deltaY = currentY - this.state.dragStart.y;

                const pixelsPerDegree = this.getPixelsPerDegree();
                const latDelta = -deltaY / pixelsPerDegree;
                const lngDelta = -deltaX / pixelsPerDegree;

                this.setCenter({
                    lat: this.state.center.lat + latDelta,
                    lng: this.state.center.lng + lngDelta
                }, false);

                this.state.dragStart = { x: currentX, y: currentY };
            }

            handleWheel(e) {
                e.preventDefault();
                const delta = e.deltaY > 0 ? -1 : 1;
                this.setZoom(this.state.zoom + delta * 0.5);
            }

            handleDoubleClick(e) {
                const rect = this.canvas.getBoundingClientRect();
                const screenX = e.clientX - rect.left;
                const screenY = e.clientY - rect.top;
                const geo = this.screenToGeo(screenX, screenY);

                this.animateTo(geo, this.state.zoom + 2, this.config.animationDuration);
            }

            handleClick(e) {
                const rect = this.canvas.getBoundingClientRect();
                const clickX = e.clientX - rect.left;
                const clickY = e.clientY - rect.top;

                // Check markers
                for (const marker of this.visibleMarkers) {
                    if (this.isPointInMarker(clickX, clickY, marker)) {
                        this.showPopup(marker);
                        return;
                    }
                }

                // Close popups
                this.closeAllPopups();
            }

            handleResize() {
                this.setupCanvas();
                this.render();
            }

            handleOrientationChange() {
                setTimeout(() => this.handleResize(), 100);
            }

            /**
             * Zoom controls
             */
            zoomIn() {
                this.setZoom(Math.min(this.state.zoom + 1, this.config.maxZoom), true);
            }

            zoomOut() {
                this.setZoom(Math.max(this.state.zoom - 1, this.config.minZoom), true);
            }

            /**
             * Set zoom
             */
            setZoom(zoom, animate = false) {
                zoom = Math.max(this.config.minZoom, Math.min(zoom, this.config.maxZoom));

                if (animate && !this.state.isAnimating) {
                    this.animateZoom(this.state.zoom, zoom, this.config.animationDuration);
                } else if (!animate) {
                    this.state.zoom = zoom;
                    this.updateUI();
                    this.render();
                }
            }

            /**
             * Set center
             */
            setCenter(center, animate = false) {
                if (animate && !this.state.isAnimating) {
                    this.animateTo(center, this.state.zoom, this.config.animationDuration);
                } else if (!animate) {
                    this.state.center = this.validateCoordinates(center);
                    this.updateUI();
                    this.render();
                }
            }

            /**
             * Animate to location
             */
            animateTo(center, zoom, duration) {
                if (this.state.isAnimating) return;

                this.state.isAnimating = true;
                const startCenter = { ...this.state.center };
                const startZoom = this.state.zoom;
                const startTime = Date.now();

                const animate = () => {
                    const elapsed = Date.now() - startTime;
                    const progress = Math.min(elapsed / duration, 1);
                    const eased = this.easeInOutCubic(progress);

                    this.state.center = {
                        lat: startCenter.lat + (center.lat - startCenter.lat) * eased,
                        lng: startCenter.lng + (center.lng - startCenter.lng) * eased
                    };
                    this.state.zoom = startZoom + (zoom - startZoom) * eased;

                    this.updateUI();
                    this.render();

                    if (progress < 1) {
                        requestAnimationFrame(animate);
                    } else {
                        this.state.isAnimating = false;
                    }
                };

                animate();
            }

            /**
             * Animate zoom
             */
            animateZoom(startZoom, endZoom, duration) {
                if (this.state.isAnimating) return;

                this.state.isAnimating = true;
                const startTime = Date.now();

                const animate = () => {
                    const elapsed = Date.now() - startTime;
                    const progress = Math.min(elapsed / duration, 1);
                    const eased = this.easeInOutCubic(progress);

                    this.state.zoom = startZoom + (endZoom - startZoom) * eased;
                    this.updateUI();
                    this.render();

                    if (progress < 1) {
                        requestAnimationFrame(animate);
                    } else {
                        this.state.isAnimating = false;
                    }
                };

                animate();
            }

            /**
             * Reset to initial state
             */
            reset() {
                this.animateTo(
                    this.config.center,
                    this.config.zoom,
                    this.config.animationDuration
                );
            }

            /**
             * Toggle fullscreen
             */
            toggleFullscreen() {
                if (!document.fullscreenElement) {
                    this.container.requestFullscreen?.().catch(err => {
                        this.log(`Fullscreen failed: ${err.message}`);
                    });
                } else {
                    document.exitFullscreen?.();
                }
            }

            /**
             * Easing function
             */
            easeInOutCubic(t) {
                return t < 0.5 ? 4 * t * t * t : (t - 1) * (2 * t - 2) * (2 * t - 2) + 1;
            }

            /**
             * Coordinate conversion helpers
             */
            getPixelsPerDegree() {
                const metersPerPixel = (40075016.686 * Math.cos(this.state.center.lat * Math.PI / 180)) / (Math.pow(2, this.state.zoom + 8));
                const pixelsPerMeter = 1 / metersPerPixel;
                return pixelsPerMeter / 111319.49;
            }

            screenToGeo(screenX, screenY) {
                const canvasWidth = this.canvas.width / this.config.renderQuality;
                const canvasHeight = this.canvas.height / this.config.renderQuality;
                const pixelsPerDegree = this.getPixelsPerDegree();

                return {
                    lat: this.state.center.lat - ((screenY - canvasHeight / 2) / pixelsPerDegree),
                    lng: this.state.center.lng + ((screenX - canvasWidth / 2) / pixelsPerDegree)
                };
            }

            geoToScreen(geo) {
                const canvasWidth = this.canvas.width / this.config.renderQuality;
                const canvasHeight = this.canvas.height / this.config.renderQuality;
                const pixelsPerDegree = this.getPixelsPerDegree();

                return {
                    x: canvasWidth / 2 + (geo.lng - this.state.center.lng) * pixelsPerDegree,
                    y: canvasHeight / 2 - (geo.lat - this.state.center.lat) * pixelsPerDegree
                };
            }

            /**
             * Validate coordinates
             */
            validateCoordinates(coords) {
                return {
                    lat: Math.max(-90, Math.min(90, coords.lat)),
                    lng: ((coords.lng + 180) % 360 - 180)
                };
            }

            /**
             * Layer management
             */
            loadDefaultLayers() {
                const layers = [
                    { id: 'background', name: 'Background', type: 'background', visible: true, opacity: 1, zIndex: 0, color: '#e8eaed' },
                    { id: 'waterways', name: 'Waterways', type: 'line', visible: true, opacity: 0.8, zIndex: 10, color: '#a7d6de' },
                    { id: 'roads', name: 'Roads', type: 'line', visible: true, opacity: 1, zIndex: 20, color: '#f5f5f5' },
                    { id: 'borders', name: 'Borders', type: 'line', visible: true, opacity: 0.5, zIndex: 30, color: '#ccc' }
                ];

                layers.forEach(layer => this.addLayer(layer));
                this.renderLayerControls();
            }

            addLayer(layer) {
                this.layers.set(layer.id, {
                    ...layer,
                    visible: layer.visible !== false,
                    opacity: Math.max(0, Math.min(1, layer.opacity ?? 1)),
                    zIndex: layer.zIndex ?? 0
                });
            }

            toggleLayer(layerId) {
                const layer = this.layers.get(layerId);
                if (layer) {
                    layer.visible = !layer.visible;
                    this.render();
                }
            }

            setLayerOpacity(layerId, opacity) {
                const layer = this.layers.get(layerId);
                if (layer) {
                    layer.opacity = Math.max(0, Math.min(1, parseFloat(opacity)));
                    this.render();
                }
            }

            renderLayerControls() {
                const container = document.getElementById('layerControls');
                if (!container) return;

                container.innerHTML = '';
                const layerArray = Array.from(this.layers.values())
                    .sort((a, b) => (b.zIndex ?? 0) - (a.zIndex ?? 0));

                layerArray.forEach(layer => {
                    const item = document.createElement('div');
                    item.className = 'litemap-layer-item';
                    item.innerHTML = `
                        <div class="litemap-layer-toggle ${layer.visible ? 'active' : ''}" 
                             onclick="window.__liteMap.toggleLayer('${layer.id}')"
                             role="checkbox"
                             aria-checked="${layer.visible}"
                             tabindex="0"></div>
                        <div class="litemap-layer-label">${this.escapeHtml(layer.name)}</div>
                        <input type="range" class="litemap-layer-opacity" 
                               min="0" max="1" step="0.1" value="${layer.opacity}"
                               onchange="window.__liteMap.setLayerOpacity('${layer.id}', this.value)"
                               aria-label="Opacity for ${layer.name}">
                    `;
                    container.appendChild(item);
                });
            }

            /**
             * Marker management
             */
            addDefaultMarkers() {
                const cities = [
                    { lat: 51.5074, lng: -0.1278, name: 'London', emoji: '🏴󠁧󠁢󠁥󠁮󠁧󠁿' },
                    { lat: 48.8566, lng: 2.3522, name: 'Paris', emoji: '🇫🇷' },
                    { lat: 52.5200, lng: 13.4050, name: 'Berlin', emoji: '🇩🇪' },
                    { lat: 41.9028, lng: 12.4964, name: 'Rome', emoji: '🇮🇹' },
                    { lat: 50.8503, lng: 4.3517, name: 'Brussels', emoji: '🇧🇪' }
                ];

                cities.forEach((city, i) => {
                    this.addMarker({
                        id: `city-${i}`,
                        position: { lat: city.lat, lng: city.lng },
                        title: city.name,
                        emoji: city.emoji,
                        popup: {
                            title: city.name,
                            content: `${city.lat.toFixed(4)}°, ${city.lng.toFixed(4)}°`
                        }
                    });
                });

                this.updateMarkerCount();
            }

            addMarker(marker) {
                if (this.markers.size >= this.config.maxMarkers) {
                    this.log('⚠ Maximum markers reached');
                    return null;
                }

                this.markers.set(marker.id, {
                    id: marker.id,
                    position: this.validateCoordinates(marker.position),
                    title: marker.title || 'Marker',
                    emoji: marker.emoji || '📍',
                    popup: marker.popup,
                    visible: true
                });

                this.updateMarkerCount();
                return marker.id;
            }

            removeMarker(id) {
                this.markers.delete(id);
                this.visibleMarkers.delete(id);
                this.popups.delete(id);
                this.updateMarkerCount();
            }

            updateMarkerCount() {
                const el = document.getElementById('markerCount');
                if (el) el.textContent = this.markers.size;
            }

            /**
             * Popup management
             */
            showPopup(marker) {
                if (!marker.popup) return;

                const popup = document.createElement('div');
                popup.className = 'litemap-popup';
                popup.innerHTML = `
                    <button class="litemap-popup-close" onclick="this.parentElement.remove()" aria-label="Close">×</button>
                    <div class="litemap-popup-title">${this.escapeHtml(marker.popup.title)}</div>
                    <div class="litemap-popup-content">${this.escapeHtml(marker.popup.content)}</div>
                `;

                const pos = this.geoToScreen(marker.position);
                const rect = this.canvas.getBoundingClientRect();

                popup.style.left = (rect.left + pos.x) + 'px';
                popup.style.top = (rect.top + pos.y - 50) + 'px';

                document.body.appendChild(popup);
                this.popups.set(marker.id, { marker, element: popup });
            }

            closeAllPopups() {
                this.popups.forEach(popup => {
                    if (popup.element?.parentElement) {
                        popup.element.remove();
                    }
                });
                this.popups.clear();
            }

            /**
             * Collision detection
             */
            isPointInMarker(x, y, marker) {
                const pos = this.geoToScreen(marker.position);
                const distance = Math.hypot(x - pos.x, y - pos.y);
                return distance < 20;
            }

            /**
             * Rendering
             */
            startRenderLoop() {
                if (this.renderLoopRunning) return;
                this.renderLoopRunning = true;

                const loop = () => {
                    if (!this.renderLoopRunning) return;

                    this.updatePerformance();
                    this.updateVisibleMarkers();
                    this.render();

                    this.animationFrameId = requestAnimationFrame(loop);
                };

                loop();
                this.log('Render loop started');
            }

            stopRenderLoop() {
                this.renderLoopRunning = false;
                if (this.animationFrameId) {
                    cancelAnimationFrame(this.animationFrameId);
                }
            }

            updateVisibleMarkers() {
                this.visibleMarkers.clear();
                const canvasWidth = this.canvas.width / this.config.renderQuality;
                const canvasHeight = this.canvas.height / this.config.renderQuality;

                for (const marker of this.markers.values()) {
                    if (!marker.visible) continue;

                    const pos = this.geoToScreen(marker.position);
                    const buffer = 50;

                    if (pos.x > -buffer && pos.x < canvasWidth + buffer &&
                        pos.y > -buffer && pos.y < canvasHeight + buffer) {
                        this.visibleMarkers.add(marker);
                    }
                }
            }

            render() {
                const startTime = performance.now();
                const canvasWidth = this.canvas.width / this.config.renderQuality;
                const canvasHeight = this.canvas.height / this.config.renderQuality;

                // Clear canvas
                this.ctx.fillStyle = '#e8eaed';
                this.ctx.fillRect(0, 0, canvasWidth, canvasHeight);

                // Render layers
                const sortedLayers = Array.from(this.layers.values())
                    .sort((a, b) => (a.zIndex ?? 0) - (b.zIndex ?? 0));

                sortedLayers.forEach(layer => {
                    if (layer.visible) {
                        this.renderLayer(layer, canvasWidth, canvasHeight);
                    }
                });

                // Draw grid
                this.drawGrid(canvasWidth, canvasHeight);

                // Render visible markers
                for (const marker of this.visibleMarkers) {
                    this.drawMarker(marker);
                }

                this.performance.renderTime = performance.now() - startTime;
            }

            renderLayer(layer, width, height) {
                this.ctx.globalAlpha = layer.opacity;
                this.ctx.strokeStyle = layer.color;
                this.ctx.lineWidth = 1;

                // Decorative rendering
                if (layer.id === 'waterways') {
                    this.ctx.globalAlpha = layer.opacity * 0.2;
                    for (let x = 0; x < width; x += 100) {
                        this.ctx.beginPath();
                        this.ctx.moveTo(x, 0);
                        this.ctx.lineTo(x, height);
                        this.ctx.stroke();
                    }
                }

                this.ctx.globalAlpha = 1;
            }

            drawGrid(width, height) {
                this.ctx.strokeStyle = '#f0f0f0';
                this.ctx.lineWidth = 1;
                this.ctx.globalAlpha = 0.2;

                const gridSize = this.performance.isLowEndDevice ? 100 : 50;

                for (let x = 0; x < width; x += gridSize) {
                    this.ctx.beginPath();
                    this.ctx.moveTo(x, 0);
                    this.ctx.lineTo(x, height);
                    this.ctx.stroke();
                }

                for (let y = 0; y < height; y += gridSize) {
                    this.ctx.beginPath();
                    this.ctx.moveTo(0, y);
                    this.ctx.lineTo(width, y);
                    this.ctx.stroke();
                }

                this.ctx.globalAlpha = 1;
            }

            drawMarker(marker) {
                const pos = this.geoToScreen(marker.position);
                const size = 16;

                // Shadow
                this.ctx.fillStyle = 'rgba(0, 0, 0, 0.15)';
                this.ctx.beginPath();
                this.ctx.arc(pos.x, pos.y + 2, size, 0, Math.PI * 2);
                this.ctx.fill();

                // Marker gradient
                const gradient = this.ctx.createRadialGradient(pos.x - 4, pos.y - 4, 0, pos.x, pos.y, size);
                gradient.addColorStop(0, '#667eea');
                gradient.addColorStop(1, '#764ba2');

                this.ctx.fillStyle = gradient;
                this.ctx.beginPath();
                this.ctx.arc(pos.x, pos.y, size, 0, Math.PI * 2);
                this.ctx.fill();

                // Border
                this.ctx.strokeStyle = 'white';
                this.ctx.lineWidth = 3;
                this.ctx.stroke();

                // Icon
                this.ctx.font = 'bold 14px Arial';
                this.ctx.textAlign = 'center';
                this.ctx.textBaseline = 'middle';
                this.ctx.fillStyle = 'white';
                this.ctx.fillText(marker.emoji, pos.x, pos.y);
            }

            /**
             * UI Updates
             */
            updateUI() {
                const zoomEl = document.getElementById('zoomLevel');
                if (zoomEl) zoomEl.textContent = Math.round(this.state.zoom);

                const coordEl = document.getElementById('centerCoords');
                if (coordEl) {
                    coordEl.textContent = `${this.state.center.lat.toFixed(2)}°, ${this.state.center.lng.toFixed(2)}°`;
                }

                const zoomInBtn = document.getElementById('zoomInBtn');
                const zoomOutBtn = document.getElementById('zoomOutBtn');
                if (zoomInBtn) zoomInBtn.disabled = this.state.zoom >= this.config.maxZoom;
                if (zoomOutBtn) zoomOutBtn.disabled = this.state.zoom <= this.config.minZoom;
            }

            /**
             * Performance monitoring
             */
            updatePerformance() {
                this.performance.frameCount++;
                const now = Date.now();
                const elapsed = now - this.performance.lastFrameTime;

                if (elapsed >= 1000) {
                    this.performance.fps = this.performance.frameCount;
                    this.performance.frameCount = 0;
                    this.performance.lastFrameTime = now;

                    const fpsEl = document.getElementById('fpsCounter');
                    if (fpsEl) fpsEl.textContent = Math.round(this.performance.fps);
                }
            }

            /**
             * Device detection
             */
            detectLowEndDevice() {
                const cores = navigator.hardwareConcurrency || 1;
                const ram = (navigator.deviceMemory || 4);
                return cores <= 2 || ram <= 2;
            }

            /**
             * Security: HTML escape
             */
            escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }

            /**
             * Logging
             */
            log(message) {
                if (this.config.enableDebug) {
                    console.log(`[LiteMap] ${message}`);
                }
            }

            error(message, err) {
                console.error(`[LiteMap] ${message}:`, err);
            }

            /**
             * Cleanup (for SPA)
             */
            destroy() {
                try {
                    this.stopRenderLoop();
                    this.closeAllPopups();
                    this.layers.clear();
                    this.markers.clear();
                    this.visibleMarkers.clear();

                    if (this.canvas) {
                        this.canvas.remove();
                        this.canvas = null;
                        this.ctx = null;
                    }

                    this.log('Map destroyed');
                } catch (error) {
                    this.error('Cleanup failed', error);
                }
            }
        }

        /**
         * Initialize on DOM ready
         */
        (function() {
            function initMap() {
                try {
                    window.__liteMap = new LiteMapCore('liteMapContainer', {
                        center: { lat: 51.5074, lng: -0.1278 },
                        zoom: 13,
                        minZoom: 2,
                        maxZoom: 20,
                        animationDuration: 300,
                        enableDebug: false
                    });

                    console.log('%c🗺️  LiteMap v1.0.0', 'color: #667eea; font-size: 14px; font-weight: bold;');
                    console.log('%cSingle-file, production-ready mapping library', 'color: #764ba2; font-size: 12px;');
                } catch (error) {
                    console.error('LiteMap initialization failed:', error);
                }
            }

            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', initMap);
            } else {
                initMap();
            }
        })();

        // Module export
        if (typeof module !== 'undefined' && module.exports) {
            module.exports = LiteMapCore;
        }
    </script>
</body>
</html>
