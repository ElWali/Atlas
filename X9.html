<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Atlas‑Lite v1.0.0</title>
  <style>
    html, body {
      margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden;
    }
    #map-container {
      position: relative;
      width: 100%; height: 100%;
    }
    canvas {
      width: 100%; height: 100%;
      display: block;
    }
    /* Controls & Overlays */
    .atlas-control button {
      transition: background 0.2s;
    }
    .atlas-control button:hover {
      background: #eee !important;
    }
    .atlas-attribution a {
      color: #4da3ff; text-decoration: none;
    }
    .atlas-attribution a:hover {
      text-decoration: underline;
    }
  </style>
</head>
<body>
  <div id="map-container">
    <canvas id="map"></canvas>
  </div>

  <script>
  (function (global, factory) {
    if (typeof module === "object" && typeof module.exports === "object") {
      module.exports = factory();
    } else {
      global.Atlas = factory();
    }
  })(this, function () {
    "use strict";

    const TILE_SIZE = 256;
    const EARTH_RADIUS = 6378137;
    const DEG2RAD = Math.PI / 180;
    const MAX_LATITUDE = 85.05112878;

    // --- Projection
    class WebMercatorProjection {
      project({ lat, lon }) {
        const clampedLat = Math.max(Math.min(lat, MAX_LATITUDE), -MAX_LATITUDE);
        const sin = Math.sin(clampedLat * DEG2RAD);
        return {
          x: EARTH_RADIUS * lon * DEG2RAD,
          y: EARTH_RADIUS * Math.log((1 + sin) / (1 - sin)) / 2,
        };
      }
      unproject({ x, y }) {
        return {
          lon: (x / EARTH_RADIUS) * (180/Math.PI),
          lat: (2 * Math.atan(Math.exp(y / EARTH_RADIUS)) - Math.PI / 2) * (180/Math.PI),
        };
      }
      latLngToTile({ lat, lon }, zoom) {
        const scale = 1 << zoom;
        const { x, y } = this.project({ lat, lon });
        return {
          x: (x + Math.PI * EARTH_RADIUS) / (2 * Math.PI * EARTH_RADIUS) * scale,
          y: (Math.PI * EARTH_RADIUS - y) / (2 * Math.PI * EARTH_RADIUS) * scale,
        };
      }
    }

    // --- TileLayer
    class TileLayer {
      constructor(urlTemplate, attribution = "", opts = {}) {
        this.urlTemplate = urlTemplate;
        this.attribution = attribution || "Built with Atlas‑Lite";
        this.cache = new Map();
        this.maxCacheSize = opts.maxCacheSize || 500;
        this.minZoom = opts.minZoom ?? 0;
        this.maxZoom = opts.maxZoom ?? 19;
      }
      _getTileUrl(x, y, z) {
        return this.urlTemplate
          .replace("{z}", z)
          .replace("{x}", x)
          .replace("{y}", y);
      }
      render(map) {
        const { ctx, canvas, zoom, center, projection } = map;
        const zInt = Math.floor(zoom);
        const { x: cx, y: cy } = projection.latLngToTile(center, zInt);
        const w = canvas.width, h = canvas.height;
        const cols = Math.ceil(w / TILE_SIZE) + 2;
        const rows = Math.ceil(h / TILE_SIZE) + 2;
        const startX = Math.floor(cx - cols / 2);
        const startY = Math.floor(cy - rows / 2);

        for (let dx = 0; dx < cols; dx++) {
          for (let dy = 0; dy < rows; dy++) {
            const x = startX + dx, y = startY + dy;
            const key = `${zInt}/${x}/${y}`;
            const url = this._getTileUrl(x, y, zInt);

            if (!this.cache.has(key)) {
              const img = new Image();
              img.crossOrigin = "anonymous";
              img.style.opacity = 0;
              img.onload = () => {
                img.style.transition = "opacity 0.3s"; img.style.opacity = 1;
                this.cache.get(key).loadedAt = Date.now();
              };
              img.onerror = () => {
                // Store placeholder tile canvas on error
                const place = document.createElement("canvas");
                place.width = TILE_SIZE; place.height = TILE_SIZE;
                const c = place.getContext("2d");
                c.fillStyle = "#ddd"; c.fillRect(0,0,TILE_SIZE,TILE_SIZE);
                c.strokeStyle = "#999"; c.strokeRect(0,0,TILE_SIZE,TILE_SIZE);
                c.fillStyle = "#555"; c.font="20px sans-serif"; c.fillText("⚠", TILE_SIZE/2-8, TILE_SIZE/2+8);
                this.cache.set(key, { img: place, lastUsed: Date.now() });
              };
              img.src = url;
              this.cache.set(key, { img, lastUsed: Date.now() });

              // Evict least recently used when cache exceeds max
              if (this.cache.size > this.maxCacheSize) {
                let oldestKey=null, oldestTime=Infinity;
                for (const [k,v] of this.cache.entries()) {
                  if (v.lastUsed < oldestTime) { oldestTime=v.lastUsed; oldestKey=k; }
                }
                if (oldestKey) this.cache.delete(oldestKey);
              }
            }

            const entry = this.cache.get(key);
            const imgObj = entry.img;
            entry.lastUsed = Date.now();

            const px = (x - cx) * TILE_SIZE + w / 2;
            const py = (y - cy) * TILE_SIZE + h / 2;
            if (imgObj.complete === undefined || imgObj.complete === true) {
              map.ctx.drawImage(imgObj, px, py, TILE_SIZE, TILE_SIZE);
            }
          }
        }
      }
    }

    // --- Helper
    function positionControl(el, pos="top-left") {
      el.style.position = "absolute";
      if (pos.includes("top")) el.style.top = "10px";
      if (pos.includes("bottom")) el.style.bottom = "10px";
      if (pos.includes("left")) el.style.left = "10px";
      if (pos.includes("right")) el.style.right = "10px";
    }

    // --- Controls
    class ZoomControl {
      constructor(opts={}) { this.pos = opts.position || "top-left"; }
      addTo(map) {
        this._map = map;
        this.container = document.createElement("div");
        this.container.className = "atlas-control atlas-zoom-control";
        positionControl(this.container, this.pos);
        this._btn("+","Zoom in", ()=> map.setZoom(map.zoom+1));
        this._btn("−","Zoom out", ()=> map.setZoom(map.zoom-1));
        map.container.appendChild(this.container);
      }
      _btn(label,title,fn){
        const b=document.createElement("button");
        b.className="atlas-btn atlas-zoom-btn";
        b.textContent=label; b.title=title;
        b.style.cssText="width:30px;height:30px;background:rgba(255,255,255,0.9);border:none;border-radius:4px;font-size:18px;cursor:pointer;box-shadow:0 1px 3px rgba(0,0,0,.3);";
        b.onclick=fn; this.container.appendChild(b);
      }
    }

    class FullscreenControl {
      constructor(opts={}){ this.pos=opts.position||"top-right"; }
      addTo(map){
        this._map=map; this.container=document.createElement("div");
        this.container.className="atlas-control atlas-fullscreen-control";
        positionControl(this.container,this.pos);
        const b=document.createElement("button"); 
        b.className="atlas-btn atlas-fullscreen-btn";
        b.textContent="⛶"; b.title="Fullscreen";
        b.style.cssText="width:34px;height:34px;background:rgba(255,255,255,0.9);border:none;border-radius:4px;font-size:18px;cursor:pointer;";
        b.onclick=()=>{!document.fullscreenElement?map.container.requestFullscreen():document.exitFullscreen();};
        this.container.appendChild(b); map.container.appendChild(this.container);
      }
    }

    class LayerControl {
      constructor(layers, opts={}) { this.layers=layers; this.idx=0; this.pos=opts.position||"top-left"; }
      addTo(map){
        this._map=map; this.container=document.createElement("div");
        this.container.className="atlas-control atlas-layer-control";
        positionControl(this.container,this.pos);
        const b=document.createElement("button"); 
        b.className="atlas-btn atlas-layer-btn";
        b.textContent="🌐"; b.title="Switch layer";
        b.style.cssText="width:34px;height:34px;background:rgba(255,255,255,0.9);border:none;border-radius:4px;font-size:18px;cursor:pointer;";
        b.onclick=()=>{ this.idx=(this.idx+1)%this.layers.length; map.layers=[]; map.addLayer(this.layers[this.idx]); };
        this.container.appendChild(b); map.container.appendChild(this.container);
      }
    }

    // --- Core Map
    class AtlasMap {
      constructor(id, options={}) {
        this.canvas=document.getElementById(id);
        if(!this.canvas) throw new Error("Canvas not found");
        this.ctx=this.canvas.getContext("2d");
        this.dpr=window.devicePixelRatio||1;
        this.center=options.center||{lat:0,lon:0};
        this.zoom=options.zoom||2;
        this.projection=new WebMercatorProjection();
        this.layers=[];
        this._events={};

        this.container=this.canvas.parentElement||document.body;
        this.container.setAttribute("role","application");
        this.container.setAttribute("aria-roledescription","map");
        this.container.tabIndex=0;
        this.container.style.position="relative";

        this._createOverlays();
        this._bindInteractions();
        window.addEventListener("resize", ()=>this.resize());
        this.resize();
      }

      // Events
      on(t,fn){ (this._events[t] ||= []).push(fn); return this; }
      fire(t,ev={}){ (this._events[t]||[]).forEach(fn=>fn(Object.assign({type:t,map:this},ev))); }

      _createOverlays(){
        this.scaleEl=document.createElement("div");
        this.scaleEl.className="atlas-scale-bar";
        this.scaleEl.style.cssText="position:absolute;bottom:10px;left:10px;color:#fff;font:11px sans-serif;padding:2px 6px;background:rgba(0,0,0,.5);border-radius:3px;";
        this.container.appendChild(this.scaleEl);

        this.attrEl=document.createElement("div");
        this.attrEl.className="atlas-attribution";
        this.attrEl.style.cssText="position:absolute;bottom:10px;right:10px;color:#fff;font:11px sans-serif;padding:2px 6px;background:rgba(0,0,0,.5);border-radius:3px;";
        this.container.appendChild(this.attrEl);
      }

      resize(){
        const w=this.canvas.clientWidth,h=this.canvas.clientHeight;
        this.canvas.width=w*this.dpr; this.canvas.height=h*this.dpr;
        this.ctx.setTransform(this.dpr,0,0,this.dpr,0,0);
        this.render(); this.fire("resize",{width:w,height:h});
      }

      addLayer(layer){
        this.layers.push(layer);
        if(layer.attribution) this.attrEl.innerHTML=layer.attribution;
        this.render(); return this;
      }
      addControl(control){ control.addTo(this); return this; }

      setCenter(c){ this.center=c; this.render(); this.fire("move",{center:c}); return this; }
      getCenter(){ return {...this.center}; }

      setZoom(z){
        const layer=this.layers[0];
        const min=layer?.minZoom??0, max=layer?.maxZoom??20;
        const clamped=Math.max(min,Math.min(max,z));
        if(clamped===this.zoom) return this;
        this.zoom=clamped; this.render(); this.fire("zoom",{zoom:this.zoom}); return this;
      }
      getZoom(){ return this.zoom; }

      render(){
        this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height);
        for(const l of this.layers) l.render(this);
        this._updateScaleBar();
      }

      _updateScaleBar(){
        const mPerPixel=(Math.cos(this.center.lat*DEG2RAD)*2*Math.PI*EARTH_RADIUS)/(TILE_SIZE*Math.pow(2,this.zoom));
        const steps=[1,2,5]; const target=mPerPixel*100; const exp=Math.pow(10, Math.floor(Math.log10(target)));
        let dist=exp; for(let s of steps){ if(target<s*exp){dist=s*exp;break;}}
        const px=dist/mPerPixel; const label=dist>=1000?dist/1000+" km":dist+" m";
        this.scaleEl.innerText=label; this.scaleEl.style.width=px+"px"; this.scaleEl.style.borderTop="2px solid #fff"; this.scaleEl.style.height="0px";
      }

      _bindInteractions(){
        let dragging=false,last=null;
        this.canvas.style.cursor="grab";
        this.canvas.addEventListener("mousedown",(e)=>{dragging=true;last={x:e.clientX,y:e.clientY};this.canvas.style.cursor="grabbing";});
        window.addEventListener("mousemove",(e)=>{if(!dragging)return; this._panBy(e.clientX-last.x,e.clientY-last.y); last={x:e.clientX,y:e.clientY};});
        window.addEventListener("mouseup",()=>{dragging=false;this.canvas.style.cursor="grab";});
        this.canvas.addEventListener("wheel",(e)=>{e.preventDefault();this.setZoom(this.zoom+(e.deltaY<0?1:-1));},{passive:false});
        this._initTouch();
      }

      _panBy(dx,dy){
        const zInt=Math.floor(this.zoom), scale=1<<zInt;
        const res=(2*Math.PI*EARTH_RADIUS)/(scale*TILE_SIZE);
        const cProj=this.projection.project(this.center);
        this.center=this.projection.unproject({x:cProj.x-dx*res,y:cProj.y+dy*res});
        this.render(); this.fire("move",{center:this.center});
      }

      _initTouch(){
        let last=null,pinchStart=null,startZoom=this.zoom;
        this.canvas.addEventListener("touchstart",(e)=>{
          if(e.touches.length===1) last={x:e.touches[0].clientX,y:e.touches[0].clientY};
          else if(e.touches.length===2){const dx=e.touches[0].clientX-e.touches[1].clientX,dy=e.touches[0].clientY-e.touches[1].clientY; pinchStart=Math.hypot(dx,dy); startZoom=this.zoom;}
        },{passive:false});
        this.canvas.addEventListener("touchmove",(e)=>{
          e.preventDefault();
          if(e.touches.length===1&&last){this._panBy(e.touches[0].clientX-last.x,e.touches[0].clientY-last.y); last={x:e.touches[0].clientX,y:e.touches[0].clientY};}
          else if(e.touches.length===2){const dx=e.touches[0].clientX-e.touches[1].clientX,dy=e.touches[0].clientY-e.touches[1].clientY;const dist=Math.hypot(dx,dy);if(pinchStart)this.setZoom(startZoom+Math.log2(dist/pinchStart));}
        },{passive:false});
        this.canvas.addEventListener("touchend",()=>{last=null;pinchStart=null;});
      }
    }

    const Atlas = { Map: AtlasMap, TileLayer, ZoomControl, FullscreenControl, LayerControl };
    Atlas.version = "1.0.0";
    return Atlas;
  });
  </script>

  <script>
    // Demo usage
    const map=new Atlas.Map("map",{zoom:2,center:{lat:20,lon:0}});
    const osm=new Atlas.TileLayer("https://a.tile.openstreetmap.org/{z}/{x}/{y}.png","© OSM Contributors");
    const esri=new Atlas.TileLayer("https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}","© Esri",{maxZoom:19});
    map.addLayer(osm);
    map.addControl(new Atlas.ZoomControl({position:"top-left"}));
    map.addControl(new Atlas.FullscreenControl({position:"top-right"}));
    map.addControl(new Atlas.LayerControl([osm,esri],{position:"top-left"}));
  </script>
</body>
</html>
