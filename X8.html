<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="referrer" content="origin"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>Atlas.js - Professional JavaScript Mapping Library</title><style>
html,body{margin:0;padding:0;height:100%;width:100%;overflow:hidden;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Oxygen,Ubuntu,Cantarell,'Open Sans','Helvetica Neue',sans-serif;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}
#map-container{position:relative;width:100%;height:100%;overflow:hidden;background:#000;touch-action:none;cursor:grab;-webkit-tap-highlight-color:transparent}
#map-container.dragging{cursor:grabbing;cursor:-webkit-grabbing}
#map{width:100%;height:100%;display:block}
.atlas-control-container{position:absolute;z-index:1000;pointer-events:none}
.atlas-control-container>*{pointer-events:auto}
.atlas-control-top-left{top:10px;left:10px}
.atlas-control-top-right{top:10px;right:10px}
.atlas-control-bottom-left{bottom:10px;left:10px}
.atlas-control-bottom-right{bottom:10px;right:10px}
.atlas-control-vertical{display:flex;flex-direction:column;gap:5px}
.atlas-control-horizontal{display:flex;flex-direction:row;gap:5px}
.control-btn{background:rgba(255,255,255,.9);border:1px solid #ccc;font-size:16px;padding:4px 8px;cursor:pointer;border-radius:4px;user-select:none;box-shadow:0 1px 3px rgba(0,0,0,.1);transition:all .15s ease;min-width:30px;text-align:center}
.control-btn:hover{background:rgba(240,240,240,.95);box-shadow:0 2px 5px rgba(0,0,0,.15)}
.control-btn:active{background:rgba(224,224,224,.95);transform:scale(.98);box-shadow:0 1px 2px rgba(0,0,0,.1)}
.control-btn:focus{outline:2px solid #0078A8;outline-offset:2px}
.control-btn:disabled{background:rgba(245,245,245,.9);color:#aaa;cursor:not-allowed;transform:none;border-color:#ddd;box-shadow:none}
#loading{position:absolute;top:10px;right:10px;background:rgba(255,255,255,.9);padding:4px 8px;border-radius:4px;font-size:12px;display:none;box-shadow:0 1px 3px rgba(0,0,0,.1)}
#loading.visible{display:block}
#coords{position:absolute;bottom:25px;left:5px;background:rgba(255,255,255,.7);font-size:12px;padding:2px 6px;border-radius:3px;font-family:monospace}
#zoom-overlay{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);background:rgba(255,255,255,.9);font-size:20px;padding:6px 12px;border-radius:6px;opacity:0;transition:opacity .25s ease-in-out;pointer-events:none;box-shadow:0 2px 8px rgba(0,0,0,.2);font-weight:bold;z-index:1000}
.scale-bar-container{text-align:center;font-size:11px;color:#fff;cursor:pointer;background:rgba(0,0,0,.5);padding:2px 4px;border-radius:3px}
.scale-bar{height:4px;background:#fff;margin-bottom:2px;border-radius:2px}
#attribution{position:absolute;bottom:5px;left:10px;background:rgba(0,0,0,.6);color:#fff;font-size:11px;padding:3px 6px;border-radius:3px;font-family:sans-serif;max-width:50%;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
#attribution a{text-decoration:none;color:#4d90fe;font-weight:bold}
#attribution a:hover{text-decoration:underline}
@keyframes zoom-indicator{0%{transform:scale(.2);opacity:.8}100%{transform:scale(1.2);opacity:0}}
</style></head><body>
<div id="map-container"><canvas id="map"></canvas><div id="loading">Loading: <span id="loading-count">0</span></div><div id="zoom-overlay" aria-live="polite"></div><div id="coords" aria-live="polite"></div><div id="attribution"></div></div>
<script>
const EARTH_RADIUS=6378137,EARTH_CIRCUMFERENCE=2*Math.PI*EARTH_RADIUS,MAX_LATITUDE=85.05112878,MIN_LATITUDE=-85.05112878,TILE_SIZE=256,TILE_BUFFER=3,TILE_TTL=86400000,TILE_LOAD_TIMEOUT_MS=1e4,INERTIA_DECEL=.0025,INERTIA_STOP_SPEED=.02,VELOCITY_WINDOW_MS=120,TWO_FINGER_TAP_MAX_DELAY=250,TWO_FINGER_TAP_MOVE_THRESH=10,ROTATE_MOVE_THRESH_RAD=.08,WHEEL_ZOOM_STEP=.25,WHEEL_ZOOM_DURATION=220,TAP_ZOOM_DURATION=280,SNAP_DURATION=300,FLYTO_DURATION=800;
const LAYERS={OSM:{name:"OpenStreetMap",minZoom:0,maxZoom:19,tileServers:["a","b","c"].map(s=>`https://${s}.tile.openstreetmap.org`),attribution:'© <a href="https://www.openstreetmap.org/copyright" target="_blank" rel="noopener noreferrer">OpenStreetMap contributors</a>',background:"#e6e6e6",supportsRetina:true,maxCacheSize:500},ESRI:{name:"Esri Satellite",minZoom:0,maxZoom:19,tileServers:["https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile"],attribution:'Tiles © <a href="https://services.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer" target="_blank" rel="noopener noreferrer">Esri World Imagery</a>',background:"#000000",supportsRetina:false,maxCacheSize:400},WIKIMEDIA:{name:"Wikimedia Maps",minZoom:0,maxZoom:18,tileServers:["https://maps.wikimedia.org/osm-intl"],attribution:'Wikimedia maps beta | © <a href="https://www.openstreetmap.org/copyright" target="_blank" rel="noopener noreferrer">OpenStreetMap</a> contributors',background:"#ffffff",supportsRetina:false,maxCacheSize:450}};
const CONFIG={defaultLayer:"OSM",defaultCenter:{lon:0,lat:0},defaultZoom:3,retina:"auto",retinaSuffix:"@2x"};
const EASING={easeInOutCubic:t=>t<.5?4*t*t*t:1-Math.pow(-2*t+2,3)/2},RAD2DEG=180/Math.PI,DEG2RAD=Math.PI/180;
function normalizeAngle(t){return Math.atan2(Math.sin(t),Math.cos(t))}function shortestAngleDiff(t,e){return normalizeAngle(e-t)}function wrapDeltaLon(t){return(t+180)%360+360,((t+180)%360+360)%360-180}function rot(t,e,a){const n=Math.cos(a),o=Math.sin(a);return{x:t*n-e*o,y:t*o-e*n}}
class Projection{project(t){throw new Error("project() must be implemented by subclass")}unproject(t){throw new Error("unproject() must be implemented by subclass")}}
class WebMercatorProjection extends Projection{project(t){const e=EARTH_RADIUS,a=Math.max(Math.min(MAX_LATITUDE,t.lat),MIN_LATITUDE),n=Math.sin(a*DEG2RAD);return{x:e*t.lon*DEG2RAD,y:e*Math.log((1+n)/(1-n))/2}}unproject(t){const e=EARTH_RADIUS;return{lon:t.x/e*RAD2DEG,lat:(2*Math.atan(Math.exp(t.y/e))-Math.PI/2)*RAD2DEG}}latLngToTile(t,e){const a=Math.pow(2,e),n=this.project(t);return{x:(n.x+Math.PI*EARTH_RADIUS)/(2*Math.PI*EARTH_RADIUS)*a,y:(Math.PI*EARTH_RADIUS-n.y)/(2*Math.PI*EARTH_RADIUS)*a}}tileToLatLng(t,e,a){const n=Math.pow(2,a),o={x:t/n*2*Math.PI*EARTH_RADIUS-Math.PI*EARTH_RADIUS,y:Math.PI*EARTH_RADIUS-e/n*2*Math.PI*EARTH_RADIUS};return this.unproject(o)}}
const DEFAULT_PROJECTION=new WebMercatorProjection;
class GISUtils{static toRadians(t){return t*Math.PI/180}static wrapLongitude(t){for(;t>180;)t-=360;for(;t<-180;)t+=360;return t}static clampLatitude(t){return Math.max(MIN_LATITUDE,Math.min(MAX_LATITUDE,t))}static getResolution(t,e){return EARTH_CIRCUMFERENCE*Math.cos(this.toRadians(t))/Math.pow(2,e)/TILE_SIZE}static formatDistance(t){return t<1e3?Math.round(t)+" m":(t/1e3).toFixed(1)+" km"}}
class Layer{constructor(t={}){this.options=t,this._map=null,this._events={}}addTo(t){return this._map!==t&&(this._map&&this._map.removeLayer(this),this._map=t,t.addLayer(this)),this}remove(){return this._map&&(this._map.removeLayer(this),this._map=null),this}on(t,e){return(this._events[t]??=[]).push(e),this}off(t,e){return this._events[t]?this._events[t]=e?this._events[t].filter((t=>t!==e)):[]:this,this}fire(t,e={}){const a=this._events[t];a?.length&&(e.type=t,e.target=this,a.forEach((t=>t(e))))}onAdd(){}onRemove(){}render(){}}
class TileLayer extends Layer{constructor(t,e={}){super(e),this.urlTemplate=t,this.options={minZoom:e.minZoom??0,maxZoom:e.maxZoom??18,attribution:e.attribution??"",background:e.background??"#ffffff",supportsRetina:e.supportsRetina??!1,maxCacheSize:e.maxCacheSize??500,...e},this.tileCache=new Map,this.loadingTiles=new Set,this.loadingControllers=new Map,this._retinaAvailable=!0}_getTileUrl(t,e,a){const n=Math.pow(2,a),o=((t%n)+n)%n,i=Math.floor(o),s=Math.max(0,Math.min(n-1,Math.floor(e)));let r=this.urlTemplate.replace("{z}",a).replace("{x}",i).replace("{y}",s);return this.options.supportsRetina&&this._shouldRequestRetina()&&(r+=CONFIG.retinaSuffix),r}_shouldRequestRetina(){const t=CONFIG.retina;return(("auto"===t&&(window.devicePixelRatio||1)>1.5||!0===t)&&this._retinaAvailable)}async _loadTile(t,e){if(this.tileCache.has(t))return this.tileCache.get(t);const a=new AbortController,n=a.signal;this.loadingControllers.set(t,a);const o=new Image;o.crossOrigin="anonymous";const i={img:o,loaded:!1,loadedAt:Date.now(),lastUsed:Date.now(),controller:a};this.tileCache.set(t,i),this.loadingTiles.add(t);const s=performance.now(),r=new Promise(((a,r)=>{o.onload=(()=>{i.loaded=!0,i.loadedAt=Date.now(),this.loadingTiles.delete(t),this.loadingControllers.delete(t),this._map?.scheduleRender(),this.fire("tileload",{tile:t,url:e,loadTime:performance.now()-s}),a(i)}),o.onerror=(o=>{if(n.aborted)return;if(this.options.supportsRetina&&e.includes(CONFIG.retinaSuffix))return this._retinaAvailable=!1,void(o.src=e.replace(CONFIG.retinaSuffix,""));this.loadingTiles.delete(t),this.loadingControllers.delete(t),this.fire("tileerror",{tile:t,url:e,error:o}),r(o)}),o.src=e})),l=new Promise(((e,o)=>{setTimeout((()=>{this.loadingTiles.has(t)&&(a.abort(),this.loadingTiles.delete(t),this.loadingControllers.delete(t),this.tileCache.has(t)&&this.tileCache.delete(t),this.fire("tileerror",{tile:t,url:e,error:new Error("Timeout")}),o(new Error(`Timeout loading tile: ${e}`)))}),TILE_LOAD_TIMEOUT_MS)}));try{await Promise.race([r,l])}catch(t){n.aborted||console.error("[Atlas] Tile loading failed or timed out:",t.message)}return i}_reloadTile(t,e){const a=this.tileCache.get(t);if(!a)return;const n=`${t}#r`;if(this.loadingTiles.has(n))return;const o=()=>{const o=new Image;o.crossOrigin="anonymous",this.loadingTiles.add(n),o.onload=(()=>{a.img=o,a.loaded=!0,a.loadedAt=Date.now(),this.loadingTiles.delete(n),this._map?.scheduleRender()}),o.onerror=(()=>{this.loadingTiles.delete(n)}),o.src=`${e}${e.includes("?")?"&":"?"}v=${Date.now()}`};"requestIdleCallback"in window?requestIdleCallback(o,{timeout:2e3}):setTimeout(o,100)}_evict(){if(this.tileCache.size<=this.options.maxCacheSize)return;const t=()=>{if(this.tileCache.size<=this.options.maxCacheSize)return;const t=Array.from(this.tileCache.entries()).sort(((t,e)=>t[1].lastUsed-e[1].lastUsed)),e=this.tileCache.size-this.options.maxCacheSize;for(let a=0;a<e;a++)this.tileCache.delete(t[a][0])};"requestIdleCallback"in window?requestIdleCallback(t,{timeout:2e3}):setTimeout(t,100)}_preloadAdjacentZoomTiles(){if(!this._map)return;const t=Math.floor(this._map.zoom),e=Math.min(this.options.maxZoom,t+1),a=Math.max(this.options.minZoom,t-1);if(Math.abs(this._map.zoom-t)>.3)return;const n=GISUtils.wrapLongitude(this._map.center.lon),o=this._map.projection.latLngToTile({lat:this._map.center.lat,lon:n},t),i=TILE_SIZE,s=this._map.canvas.width/this._map.dpr,r=this._map.canvas.height/this._map.dpr,l=Math.ceil(Math.max(s,r)/i)+TILE_BUFFER;for(const n of[a,e]){if(n===t)continue;const e=Math.pow(2,Math.abs(n-t)),a=Math.floor(o.x*(n>t?e:1/e)-l/2),i=Math.floor(o.y*(n>t?e:1/e)-l/2);for(let t=0;t<l;t++)for(let e=0;e<l;e++){const o=a+t,i=i+e,s=`${n}/${o}/${i}`;this.tileCache.has(s)||this.loadingTiles.has(s)||this._loadTile(s,this._getTileUrl(o,i,n))}}}render(){if(!this._map)return;const t=this._map.canvas.width/this._map.dpr,e=this._map.canvas.height/this._map.dpr,a=Math.floor(this._map.zoom),n=Math.pow(2,this._map.zoom-a),o=TILE_SIZE,i=GISUtils.wrapLongitude(this._map.center.lon),s=this._map.projection.latLngToTile({lat:this._map.center.lat,lon:i},a),r=Math.abs(Math.cos(this._map.bearing)),l=Math.abs(Math.sin(this._map.bearing)),d=t*r+e*l,h=t*l+e*r,c=Math.ceil(d/(o*n))+TILE_BUFFER,u=Math.ceil(h/(o*n))+TILE_BUFFER,m=Math.floor(s.x-c/2),g=Math.floor(s.y-u/2),p=[];for(let t=0;t<c;t++)for(let e=0;e<u;e++){const a=m+t,n=g+e,i=Math.hypot(t-c/2,e-u/2);p.push({X:a,Y:n,dist:i})}p.sort(((t,e)=>t.dist-e.dist));const v=this._map.ctx;v.save(),v.translate(t/2,e/2),v.rotate(this._map.bearing),v.scale(n,n),v.imageSmoothingEnabled=!1;for(const{X:t,Y:e}of p){const n=`${a}/${t}/${e}`,i=this._getTileUrl(t,e,a),r=(t-s.x)*o,l=(e-s.y)*o,d=this.tileCache.get(n);d?d.loaded&&(v.drawImage(d.img,r,l,o,o),d.lastUsed=Date.now(),Date.now()-d.loadedAt>TILE_TTL&&this._reloadTile(n,i)):this._loadTile(n,i)}v.restore(),this._evict(),this._preloadAdjacentZoomTiles()}onAdd(){this.fire("add")}onRemove(){for(const t of this.loadingControllers.values())t.abort();this.loadingTiles.clear(),this.loadingControllers.clear(),this.tileCache.clear(),this.fire("remove")}getAttribution(){return this.options.attribution}getBackground(){return this.options.background}getMinZoom(){return this.options.minZoom}getMaxZoom(){return this.options.maxZoom}}
class GeoJSONLayer extends Layer{constructor(t,e={}){super(e),this._geojson=this._normalizeGeoJSON(t),this._features=[],this._featureCache=new Map,this._hitCache=new Map,this._lastRenderZoom=null,this._lastRenderBearing=null,this._lastRenderCenter=null,this.options.style=e.style||{color:"#3388ff",weight:3,opacity:1,fillColor:"#3388ff",fillOpacity:.2},this.options.interactive=e.interactive??!0,this._onMouseMove=this._onMouseMove.bind(this),this._onMouseOut=this._onMouseOut.bind(this),this._onClick=this._onClick.bind(this)}_normalizeGeoJSON(t){return Array.isArray(t)?{type:"FeatureCollection",features:t.map((t=>"Feature"===t.type?t:{type:"Feature",geometry:t,properties:{}}))}:"FeatureCollection"===t.type?t:"Feature"===t.type?{type:"FeatureCollection",features:[t]}:{type:"FeatureCollection",features:[{type:"Feature",geometry:t,properties:{}}]}}_latLngToScreenPoint(t){if(!this._map)return{x:0,y:0};const[e,a]=t,n=this._map.canvas.width/this._map.dpr,o=this._map.canvas.height/this._map.dpr,i=Math.floor(this._map.zoom),s=TILE_SIZE*Math.pow(2,this._map.zoom-i),r=this._map.projection.latLngToTile(this._map.center,i),l=this._map.projection.latLngToTile({lat:a,lon:e},i),d=(l.x-r.x)*s,h=(l.y-r.y)*s,c=rot(d,h,this._map.bearing);return{x:n/2+c.x,y:o/2+c.y}}_getFeatureStyle(t){return"function"==typeof this.options.style?this.options.style(t):this.options.style}_processFeature(t){const e=JSON.stringify(t);if(this._featureCache.has(e))return this._featureCache.get(e);const a=t.geometry,n={type:a.type,coordinates:null,properties:t.properties};try{switch(a.type){case"Point":n.coordinates=this._latLngToScreenPoint(a.coordinates);break;case"MultiPoint":n.coordinates=a.coordinates.map((t=>this._latLngToScreenPoint(t)));break;case"LineString":n.coordinates=a.coordinates.map((t=>this._latLngToScreenPoint(t)));break;case"MultiLineString":n.coordinates=a.coordinates.map((t=>t.map((t=>this._latLngToScreenPoint(t)))));break;case"Polygon":n.coordinates=a.coordinates.map((t=>t.map((t=>this._latLngToScreenPoint(t)))));break;case"MultiPolygon":n.coordinates=a.coordinates.map((t=>t.map((t=>t.map((t=>this._latLngToScreenPoint(t)))))));break;default:return console.warn("[Atlas] Unsupported geometry type:",a.type),null}}catch(t){return console.error("[Atlas] Error processing feature:",t),null}return this._featureCache.set(e,n),n}_renderPoint(t,e,a){const{x:n,y:o}=e.coordinates;t.beginPath(),t.arc(n,o,a.radius||5,0,2*Math.PI),t.fillStyle=a.fillColor||a.color||"#3388ff",t.fill(),!1!==a.stroke&&(t.strokeStyle=a.color||"#3388ff",t.lineWidth=a.weight||2,t.globalAlpha=a.opacity||1,t.stroke()),t.globalAlpha=1}_renderLineString(t,e,a){const n=e.coordinates;if(!(n.length<2)){t.beginPath(),t.moveTo(n[0].x,n[0].y);for(let e=1;e<n.length;e++)t.lineTo(n[e].x,n[e].y);t.strokeStyle=a.color||"#3388ff",t.lineWidth=a.weight||3,t.globalAlpha=a.opacity||1,t.stroke(),t.globalAlpha=1}}_renderPolygon(t,e,a){const n=e.coordinates;if(n?.length){t.beginPath();for(const e of n){if(e.length<3)continue;t.moveTo(e[0].x,e[0].y);for(let a=1;a<e.length;a++)t.lineTo(e[a].x,e[a].y);t.closePath()}"false"!==a.fill&&(t.fillStyle=a.fillColor||a.color||"#3388ff",t.globalAlpha=a.fillOpacity||.2,t.fill(),t.globalAlpha=1),!1!==a.stroke&&(t.strokeStyle=a.color||"#3388ff",t.lineWidth=a.weight||3,t.globalAlpha=a.opacity||1,t.stroke(),t.globalAlpha=1)}}_pointInPolygon(t,e,a){let n=!1;for(let o=0,i=a.length-1;o<a.length;i=o++){const s=a[o].x,r=a[o].y,l=a[i].x,d=a[i].y,h=r>e!=d>e&&t<(l-s)*(e-r)/(d-r)+s;h&&(n=!n)}return n}_hitDetect(t,e){const a=`${this._map.zoom.toFixed(6)}_${this._map.bearing}_${this._map.center.lon}_${this._map.center.lat}`;if(!this._hitCache.has(a)){const a=new Map;for(const n of this._features){const o=this._processFeature(n);if(!o)continue;switch(o.type){case"Point":{const a=Math.hypot(t-o.coordinates.x,e-o.coordinates.y);a<=(this._getFeatureStyle(n).radius||5)+5&&a.set(`${t}_${e}`,n);break}case"Polygon":{for(const i of o.coordinates)if(this._pointInPolygon(t,e,i)){a.set(`${t}_${e}`,n);break}break}}}this._hitCache.set(a,a)}return this._hitCache.get(a).get(`${t}_${e}`)||null}_onMouseMove(t){const e=this._map.canvas.getBoundingClientRect(),a=t.clientX-e.left,n=t.clientY-e.top,o=this._hitDetect(a,n);this._map.canvas.style.cursor=o?"pointer":"grab",o?this.fire("mousemove",{originalEvent:t,feature:o}):this.fire("mouseout",{originalEvent:t})}_onMouseOut(t){this._map.canvas.style.cursor="grab",this.fire("mouseout",{originalEvent:t})}_onClick(t){const e=this._map.canvas.getBoundingClientRect(),a=t.clientX-e.left,n=t.clientY-e.top,o=this._hitDetect(a,n);o&&this.fire("click",{originalEvent:t,feature:o})}onAdd(){this._features=this._geojson.features||[],this.options.interactive&&(this._map.canvas.addEventListener("mousemove",this._onMouseMove),this._map.canvas.addEventListener("mouseout",this._onMouseOut),this._map.canvas.addEventListener("click",this._onClick)),this.fire("add")}onRemove(){this.options.interactive&&(this._map.canvas.removeEventListener("mousemove",this._onMouseMove),this._map.canvas.removeEventListener("mouseout",this._onMouseOut),this._map.canvas.removeEventListener("click",this._onClick)),this._featureCache.clear(),this._hitCache.clear(),this.fire("remove")}render(){if(!this._map)return;const t=this._map.ctx,e:this._lastRenderZoom!==this._map.zoom||this._lastRenderBearing!==this._map.bearing||this._lastRenderCenter?.lon!==this._map.center.lon||this._lastRenderCenter?.lat!==this._map.center.lat;e&&(this._featureCache.clear(),this._hitCache.clear(),this._lastRenderZoom=this._map.zoom,this._lastRenderBearing=this._map.bearing,this._lastRenderCenter={...this._map.center});for(const e of this._features){const a=this._processFeature(e);if(!a)continue;const n=this._getFeatureStyle(e);switch(a.type){case"Point":this._renderPoint(t,a,n);break;case"LineString":this._renderLineString(t,a,n);break;case"Polygon":this._renderPolygon(t,a,n)}}}setData(t){return this._geojson=this._normalizeGeoJSON(t),this._features=this._geojson.features||[],this._featureCache.clear(),this._hitCache.clear(),this._map?.render(),this}getData(){return this._geojson}}
class Handler{constructor(t){this._map=t,this._enabled=!1,this._eventListeners={}}enable(){return this._enabled||(this._enabled=!0,this._addEvents()),this}disable(){return this._enabled&&(this._enabled=!1,this._removeEvents()),this}toggle(){return this._enabled?this.disable():this.enable()}isEnabled(){return this._enabled}_addEvents(){}_removeEvents(){}destroy(){this.disable(),this._eventListeners={}}}
class DragPanHandler extends Handler{constructor(t){super(t),this._isDragging=!1,this._dragStart=null,this._moveSamples=[]}_addEvents(){this._map.canvas.addEventListener("mousedown",this._onMouseDown=this._onMouseDown.bind(this)),this._map.canvas.addEventListener("touchstart",this._onTouchStart=this._onTouchStart.bind(this),{passive:!1})}_removeEvents(){this._map.canvas.removeEventListener("mousedown",this._onMouseDown),this._map.canvas.removeEventListener("touchstart",this._onTouchStart),this._removeMoveEvents()}_removeMoveEvents(){document.removeEventListener("mousemove",this._onMouseMove),document.removeEventListener("mouseup",this._onMouseUp),document.removeEventListener("touchmove",this._onTouchMove,{passive:!1}),document.removeEventListener("touchend",this._onTouchEnd),document.removeEventListener("touchcancel",this._onTouchEnd)}_onMouseDown(t){0===t.button&&(this._startDrag(t.clientX,t.clientY),document.addEventListener("mousemove",this._onMouseMove=this._onMouseMove.bind(this)),document.addEventListener("mouseup",this._onMouseUp=this._onMouseUp.bind(this)))}_onMouseMove(t){if(this._isDragging){t.preventDefault();const e=t.clientX-this._dragStart.x,a=t.clientY-this._dragStart.y,n=this._map.canvas.width/this._map.dpr,o=this._map.canvas.height/this._map.dpr;this._map.center=this._map.screenToLatLon(n/2-e,o/2-a,this._map.zoom,this._map.bearing,this._dragStart.center),this._pushVelocitySample(t.clientX,t.clientY),this._map.render()}}_onMouseUp(){this._endDrag()}_onTouchStart(t){1===t.touches.length&&(t.preventDefault(),this._startDrag(t.touches[0].clientX,t.touches[0].clientY),document.addEventListener("touchmove",this._onTouchMove=this._onTouchMove.bind(this),{passive:!1}),document.addEventListener("touchend",this._onTouchEnd=this._onTouchEnd.bind(this)),document.addEventListener("touchcancel",this._onTouchEnd))}_onTouchMove(t){if(this._isDragging&&1===t.touches.length){t.preventDefault();const e=t.touches[0].clientX-this._dragStart.x,a=t.touches[0].clientY-this._dragStart.y,n=this._map.canvas.width/this._map.dpr,o=this._map.canvas.height/this._map.dpr;this._map.center=this._map.screenToLatLon(n/2-e,o/2-a,this._map.zoom,this._map.bearing,this._dragStart.center),this._pushVelocitySample(t.touches[0].clientX,t.touches[0].clientY),this._map.render()}}_onTouchEnd(){this._endDrag()}_startDrag(t,e){this._isDragging=!0,this._map.stopAnimations(),this._map.isDragging=!0,this._map.container.classList.add("dragging"),this._dragStart={x:t,y:e,center:{...this._map.center}},this._moveSamples=[],this._pushVelocitySample(t,e)}_endDrag(){if(this._isDragging){this._isDragging=!1,this._map.isDragging=!1,this._map.container.classList.remove("dragging");const{vx:t,vy:e}=this._computeVelocity();this._startInertia(t,e),this._removeMoveEvents()}}_pushVelocitySample(t,e){const a=performance.now();for(this._moveSamples.push({t:a,x:t,y:e});this._moveSamples.length&&this._moveSamples[0].t<a-VELOCITY_WINDOW_MS;)this._moveSamples.shift()}_computeVelocity(){if(this._moveSamples.length<2)return{vx:0,vy:0};const t=this._moveSamples[this._moveSamples.length-1];let e=this._moveSamples.length-2;for(;e>0&&t.t-this._moveSamples[e].t<.5*VELOCITY_WINDOW_MS;)e--;const a=this._moveSamples[e],n=Math.max(1,t.t-a.t);return{vx:(t.x-a.x)/n,vy:(t.y-a.y)/n}}_startInertia(t,e){const a=Math.hypot(t,e);if(a<INERTIA_STOP_SPEED)return;let n=performance.now();const o=()=>{const i=performance.now(),s=i-n;n=i;const r=t*s,l=e*s,d=this._map.canvas.width/this._map.dpr,h=this._map.canvas.height/this._map.dpr;this._map.center=this._map.screenToLatLon(d/2-r,h/2-l);const c=Math.hypot(t,e),u=Math.max(0,c-INERTIA_DECEL*s);if(u<=INERTIA_STOP_SPEED)return this._map.render(),this._map._inertiaRAF=null,void this._map.fire("moveend");const m=u/(c||1);t*=m,e*=m,this._map.render(),this._map._inertiaRAF=requestAnimationFrame(o)};this._map._inertiaRAF=requestAnimationFrame(o)}}
class ScrollZoomHandler extends Handler{_addEvents(){this._map.canvas.addEventListener("wheel",this._onWheel=this._onWheel.bind(this),{passive:!1})}_removeEvents(){this._map.canvas.removeEventListener("wheel",this._onWheel)}_onWheel(t){t.preventDefault();const e=t.deltaY<0?WHEEL_ZOOM_STEP:-WHEEL_ZOOM_STEP;this._map.smoothZoomAt(t.clientX,t.clientY,e)}}
class DoubleClickZoomHandler extends Handler{_addEvents(){this._map.canvas.addEventListener("dblclick",this._onDoubleClick=this._onDoubleClick.bind(this))}_removeEvents(){this._map.canvas.removeEventListener("dblclick",this._onDoubleClick)}_onDoubleClick(t){t.preventDefault(),this._map.animateZoomRotateAbout(t.clientX,t.clientY,this._map.getZoom()+1,this._map.getBearing(),TAP_ZOOM_DURATION)}}
class TouchZoomRotateHandler extends Handler{constructor(t){super(t),this._isPinching=!1,this._pinchStartDist=0,this._pinchStartAngle=0,this._pinchStartZoom=t.getZoom(),this._pinchStartBearing=t.getBearing(),this._pinchStartTime=0,this._pinchLastCenter=null,this._pinchMoved=!1,this._pinchAnchorLL=null}_addEvents(){this._map.canvas.addEventListener("touchstart",this._onTouchStart=this._onTouchStart.bind(this),{passive:!1})}_removeEvents(){this._map.canvas.removeEventListener("touchstart",this._onTouchStart),this._removeMoveEvents()}_removeMoveEvents(){document.removeEventListener("touchmove",this._onTouchMove,{passive:!1}),document.removeEventListener("touchend",this._onTouchEnd),document.removeEventListener("touchcancel",this._onTouchEnd)}_onTouchStart(t){if(t.touches.length<2)return;t.preventDefault(),this._startPinch(t),document.addEventListener("touchmove",this._onTouchMove=this._onTouchMove.bind(this),{passive:!1}),document.addEventListener("touchend",this._onTouchEnd=this._onTouchEnd.bind(this)),document.addEventListener("touchcancel",this._onTouchEnd)}_startPinch(t){this._map.stopAnimations(),this._isPinching=!0;const e=t.touches[0],a=t.touches[1];this._pinchStartDist=Math.hypot(a.clientX-e.clientX,a.clientY-e.clientY),this._pinchStartAngle=Math.atan2(a.clientY-e.clientY,a.clientX-e.clientX),this._pinchStartZoom=this._map.getZoom(),this._pinchStartBearing=this._map.getBearing(),this._pinchStartTime=performance.now(),this._pinchLastCenter={x:(e.clientX+a.clientX)/2,y:(e.clientY+a.clientY)/2},this._pinchAnchorLL=this._map.screenToLatLon(this._pinchLastCenter.x,this._pinchLastCenter.y,this._map.getZoom(),this._map.getBearing(),this._map.getCenter()),this._pinchMoved=!1}_onTouchMove(t){if(!this._isPinching||t.touches.length<2)return;t.preventDefault();const e=t.touches[0],a=t.touches[1],n=Math.hypot(a.clientX-e.clientX,a.clientY-e.clientY),o=Math.atan2(a.clientY-e.clientY,a.clientX-e.clientX),i={x:(e.clientX+a.clientX)/2,y:(e.clientY+a.clientY)/2},s=this._pinchStartZoom+Math.log2(n/Math.max(1,this._pinchStartDist)),r=normalizeAngle(o-this._pinchStartAngle),l=normalizeAngle(this._pinchStartBearing+r);(Math.abs(Math.log(n/Math.max(1,this._pinchStartDist)))>Math.log(1+TWO_FINGER_TAP_MOVE_THRESH/Math.max(1,this._pinchStartDist))||Math.abs(r)>ROTATE_MOVE_THRESH_RAD)&&(this._pinchMoved=!0),this._map.applyZoomRotateAbout(i.x,i.y,s,l,this._pinchAnchorLL),this._pinchLastCenter=i,this._map.render()}_onTouchEnd(){if(!this._isPinching)return;const t=performance.now()-this._pinchStartTime;if(t<=TWO_FINGER_TAP_MAX_DELAY&&!this._pinchMoved){const t=this._pinchLastCenter?.x??this._map.canvas.width/this._map.dpr/2,e=this._pinchLastCenter?.y??this._map.canvas.height/this._map.dpr/2;this._map.animateZoomRotateAbout(t,e,this._map.getZoom()-1,this._map.getBearing(),TAP_ZOOM_DURATION)}this._isPinching=!1,this._removeMoveEvents()}}
class KeyboardPanHandler extends Handler{_addEvents(){window.addEventListener("keydown",this._onKeyDown=this._onKeyDown.bind(this))}_removeEvents(){window.removeEventListener("keydown",this._onKeyDown)}_onKeyDown(t){let e=0,a=0;const n=1;switch(t.key){case"ArrowUp":a=n;break;case"ArrowDown":a=-n;break;case"ArrowLeft":e=-n;break;case"ArrowRight":e=n;break;case"n":{t.preventDefault();const e=this._map.canvas.width/this._map.dpr,a=this._map.canvas.height/this._map.dpr;this._map.animateZoomRotateAbout(e/2,a/2,this._map.getZoom(),0,SNAP_DURATION)}return;case"r":return t.preventDefault(),void this._map.setBearing(this._map.getBearing()+15*DEG2RAD);case"l":return t.preventDefault(),void this._map.setBearing(this._map.getBearing()-15*DEG2RAD);case"s":{t.preventDefault();const e=this._map.getBaseLayer();let a;a=!e||e.urlTemplate.includes("openstreetmap.org")?"ESRI":e.urlTemplate.includes("arcgisonline.com")?"WIKIMEDIA":"OSM";const n=LAYERS[a];if(!n)return;const o="ESRI"===a?"https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}":`${n.tileServers[0]}/{z}/{x}/{y}.png`,i=new TileLayer(o,{minZoom:n.minZoom,maxZoom:n.maxZoom,attribution:n.attribution,background:n.background,supportsRetina:n.supportsRetina,maxCacheSize:n.maxCacheSize});this._map.setBaseLayer(i)}return;case"+":case"=":return t.preventDefault(),void this._map.setZoom(this._map.getZoom()+1);case"-":return t.preventDefault(),void this._map.setZoom(this._map.getZoom()-1)}0!==e||0!==a&&(t.preventDefault(),this._map.stopAnimations(),this._map.center={lat:GISUtils.clampLatitude(this._map.getCenter().lat+a),lon:GISUtils.wrapLongitude(this._map.getCenter().lon+e)},this._map.render())}}
class Control{constructor(t={}){this.options={position:t.position||"top-left"},this._map=null,this._container=null,this._events={}}on(t,e){return(this._events[t]??=[]).push(e),this}off(t,e){return this._events[t]?this._events[t]=e?this._events[t].filter((t=>t!==e)):[]:this,this}fire(t,e={}){const a=this._events[t];a?.length&&(e.type=t,e.target=this,a.forEach((t=>t(e))))}onAdd(){return document.createElement("div")}onRemove(){}addTo(t){return this.remove(),this._map=t,this._container=this.onAdd(),this._container.controlInstance=this,this._addToContainer(),this}remove(){return this._map&&(this.onRemove(),this._container?.parentNode?.removeChild(this._container),this._map=null,this._container=null),this}getContainer(){return this._container}_addToContainer(){if(!this._map||!this._container)return;const t=this.options.position;let e=this._map._controlCorners[t];e||(e=document.createElement("div"),e.className=`atlas-control-container atlas-control-${t}`,t.includes("top")||t.includes("bottom")?e.classList.add("atlas-control-vertical"):e.classList.add("atlas-control-horizontal"),this._map.container.appendChild(e),this._map._controlCorners[t]=e),e.appendChild(this._container)}}
class ZoomControl extends Control{constructor(t={}){super(t),this.options={...this.options,zoomInTitle:t.zoomInTitle||"Zoom in",zoomOutTitle:t.zoomOutTitle||"Zoom out"}}onAdd(){const t=document.createElement("div");t.className="atlas-zoom-control";const e=(t,e,a)=>{const n=document.createElement("button");return n.className="control-btn",n.title=e,n.setAttribute("aria-label",e),n.textContent=t,n.onclick=a,n};return this._zoomInBtn=e("+",this.options.zoomInTitle,(()=>this._map?.setZoom(this._map.getZoom()+1))),this._zoomOutBtn=e("−",this.options.zoomOutTitle,(()=>this._map?.setZoom(this._map.getZoom()-1))),t.appendChild(this._zoomInBtn),t.appendChild(this._zoomOutBtn),t}_update(){if(!this._map||!this._zoomInBtn||!this._zoomOutBtn)return;const t=this._map.getBaseLayer()?.getMinZoom()??0,e=this._map.getBaseLayer()?.getMaxZoom()??18,a=this._map.getZoom();this._zoomInBtn.disabled=a>=e,this._zoomOutBtn.disabled=a<=t}}
class LayerControl extends Control{constructor(t={}){super(t),this.options={...this.options,title:t.title||"Toggle layer"}}onAdd(){const t=document.createElement("div");t.className="atlas-layer-control";const e=document.createElement("button");return e.className="control-btn",e.title=this.options.title,e.setAttribute("aria-label",this.options.title),e.textContent="🌐",e.onclick=()=>{if(!this._map)return;const t=this._map.getBaseLayer();let e;e=!t||t.urlTemplate.includes("openstreetmap.org")?"ESRI":t.urlTemplate.includes("arcgisonline.com")?"WIKIMEDIA":"OSM";const a=LAYERS[e];if(!a)return;const n="ESRI"===e?"https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}":`${a.tileServers[0]}/{z}/{x}/{y}.png`,o=new TileLayer(n,{minZoom:a.minZoom,maxZoom:a.maxZoom,attribution:a.attribution,background:a.background,supportsRetina:a.supportsRetina,maxCacheSize:a.maxCacheSize});this._map.setBaseLayer(o)},t.appendChild(e),this._toggleBtn=e,t}}
class FullscreenControl extends Control{constructor(t={}){super(t),this.options={...this.options,title:t.title||"Toggle fullscreen"}}onAdd(){const t=document.createElement("div");t.className="atlas-fullscreen-control";const e=document.createElement("button");return e.className="control-btn",e.title=this.options.title,e.setAttribute("aria-label",this.options.title),e.textContent="⛶",e.onclick=()=>{document.fullscreenElement?document.exitFullscreen().catch((t=>console.warn(`[Atlas] Exit FS error: ${t.message}`))):this._map?.container?.requestFullscreen().catch((t=>console.warn(`[Atlas] Fullscreen error: ${t.message}`)))},t.appendChild(e),this._fullscreenBtn=e,t}}
class ScaleControl extends Control{constructor(t={}){super(t),this.options={...this.options,maxWidth:t.maxWidth||150,unit:t.unit||"metric"}}onAdd(){const t=document.createElement("div");return t.className="atlas-scale-control scale-bar-container",this._scaleBar=document.createElement("div"),this._scaleBar.className="scale-bar",this._scaleText=document.createElement("div"),this._scaleText.id="scale-text",this._scaleText.dataset.unit=this.options.unit,t.appendChild(this._scaleBar),t.appendChild(this._scaleText),this._scaleText.addEventListener("click",(()=>{this._scaleText.dataset.unit="metric"===this._scaleText.dataset.unit?"imperial":"metric",this._update()})),t}onRemove(){this._scaleText?.removeEventListener("click",this._update)}_update(){if(!this._map||!this._scaleBar||!this._scaleText)return;const t=GISUtils.getResolution(this._map.getCenter().lat,this._map.getZoom()),e=t*this.options.maxWidth,a=Math.pow(10,Math.floor(Math.log10(e))),n=e/a,o=n>=5?5:n>=2?2:1,i=o*a,s=Math.max(20,Math.min(this.options.maxWidth,i/t));this._scaleBar.style.width=`${s}px`,"metric"===this._scaleText.dataset.unit?this._scaleText.textContent=GISUtils.formatDistance(i):(t=3.28084*i,this._scaleText.textContent=t<5280?`${Math.round(t)} ft`:`${(t/5280).toFixed(1)} mi`)}}class AttributionControl extends Control{constructor(t={}){super(t),this.options={...this.options,prefix:t.prefix||""}}onAdd(){const t=document.createElement("div");return t.className="atlas-attribution-control",t.id="attribution",t.innerHTML=this.options.prefix,this._container=t,t}_update(){if(!this._map||!this._container)return;const t=this._map.getBaseLayer()?.getAttribution()??"";this._container.innerHTML=this.options.prefix+(this.options.prefix&&t?" | ":"")+t}}
class CompassControl extends Control{constructor(t={}){super(t),this.options={...this.options,title:t.title||"Reset North"}}onAdd(){const t=document.createElement("div");t.className="atlas-compass-control";const e=document.createElement("button");return e.id="compass",e.className="control-btn",e.title=this.options.title,e.setAttribute("aria-label",this.options.title),e.textContent="N",e.style.display="none",e.onclick=(()=>{if(this._map){const t=this._map.canvas.width/this._map.dpr,e=this._map.canvas.height/this._map.dpr;this._map.animateZoomRotateAbout(t/2,e/2,this._map.getZoom(),0,SNAP_DURATION)}}),t.appendChild(e),this._compassBtn=e,e.onmouseenter=(()=>e.style.background="rgba(240, 240, 240, 0.95)"),e.onmouseleave=(()=>{e.style.background="rgba(255, 255, 255, 0.9)",e.style.transform=`rotate(${-this._map.getBearing()*RAD2DEG}deg)`}),e.onmousedown=(()=>e.style.transform=`scale(0.98) rotate(${-this._map.getBearing()*RAD2DEG}deg)`),e.onmouseup=(()=>{e.style.background="rgba(255, 255, 255, 0.9)",e.style.transform=`rotate(${-this._map.getBearing()*RAD2DEG}deg)`}),t}_update(){if(!this._compassBtn||!this._map)return;const t=Math.abs(this._map.getBearing())>.001;this._compassBtn.style.display=t?"block":"none",this._compassBtn.style.transform=`rotate(${-this._map.getBearing()*RAD2DEG}deg)`}}
class ResetZoomControl extends Control{constructor(t={}){super(t),this.options={...this.options,title:t.title||"Reset Zoom"}}onAdd(){const t=document.createElement("div");t.className="atlas-reset-zoom-control";const e=document.createElement("button");return e.id="reset-zoom",e.className="control-btn",e.title=this.options.title,e.setAttribute("aria-label",this.options.title),e.textContent="⤢",e.onclick=(()=>{this._map?.flyTo({center:CONFIG.defaultCenter,zoom:CONFIG.defaultZoom,duration:SNAP_DURATION})}),t.appendChild(e),this._resetBtn=e,e.onmouseenter=(()=>e.style.background="rgba(240, 240, 240, 0.95)"),e.onmouseleave=(()=>{e.style.background="rgba(255, 255, 255, 0.9)",e.style.transform="scale(1)"}),e.onmousedown=(()=>e.style.transform="scale(0.98)"),e.onmouseup=(()=>{e.style.background="rgba(255, 255, 255, 0.9)",e.style.transform="scale(1)"}),t}}
class Atlas{constructor(t,e={}){Object.assign(CONFIG,e),this.canvas=document.getElementById(t);if(!this.canvas)throw new Error(`Canvas element with ID '${t}' not found.`);this.ctx=this.canvas.getContext("2d"),this.container=document.getElementById("map-container");if(!this.container)throw new Error("Map container element not found.");this.center={lon:GISUtils.wrapLongitude(CONFIG.defaultCenter.lon),lat:GISUtils.clampLatitude(CONFIG.defaultCenter.lat)},this.zoom=CONFIG.defaultZoom,this.bearing=0,this.renderScheduled=!1,this.zoomOverlay=document.getElementById("zoom-overlay"),this.loadingEl=document.getElementById("loading"),this.loadingCountEl=document.getElementById("loading-count"),this.coordsEl=document.getElementById("coords"),this._inertiaRAF=null,this._layers=[],this._baseLayer=null,this._events={},this._controls=[],this._controlCorners={},this._handlers={},this.projection=DEFAULT_PROJECTION,this.addHandler("dragPan",DragPanHandler),this.addHandler("scrollZoom",ScrollZoomHandler),this.addHandler("doubleClickZoom",DoubleClickZoomHandler),this.addHandler("touchZoomRotate",TouchZoomRotateHandler),this.addHandler("keyboardPan",KeyboardPanHandler),this.resize(),this._addDefaultControls(),this.updateAttribution(),this.render(),this.fire("load")}_addDefaultControls(){this.addControl(new ZoomControl({position:"top-left"})),this.addControl(new LayerControl({position:"top-left"})),this.addControl(new FullscreenControl({position:"top-right"})),this.addControl(new ScaleControl({position:"bottom-right"})),this.addControl(new AttributionControl({position:"bottom-left"})),this.addControl(new CompassControl({position:"top-left"})),this.addControl(new ResetZoomControl({position:"top-left"}))}on(t,e){return(this._events[t]??=[]).push(e),this}off(t,e){return this._events[t]?this._events[t]=e?this._events[t].filter((t=>t!==e)):[]:this,this}fire(t,e={}){const a=this._events[t];a?.length&&(e.type=t,e.target=this,a.forEach((t=>t(e))))}addLayer(t){if(!(t instanceof Layer))throw new Error("Argument must be an instance of Layer");return this._layers.includes(t)||(this._layers.push(t),t._map=this,t.onAdd(),this.render(),!this._baseLayer&&t instanceof TileLayer&&(this._baseLayer=t,this.container.style.background=t.getBackground())),this}removeLayer(t){const e=this._layers.indexOf(t);return-1!==e&&(this._layers.splice(e,1),t.onRemove(),t._map=null,this._baseLayer===t&&(this._baseLayer=this._layers.find((t=>t instanceof TileLayer))||null,this._baseLayer&&(this.container.style.background=this._baseLayer.getBackground())),this.render()),this}setBaseLayer(t){if(!(t instanceof TileLayer))throw new Error("Argument must be an instance of TileLayer");return this._baseLayer&&this._baseLayer!==t&&this.removeLayer(this._baseLayer),this._layers.includes(t)?(this._baseLayer=t,this.container.style.background=t.getBackground(),this.zoom=Math.max(t.getMinZoom(),Math.min(t.getMaxZoom(),this.zoom)),this.render()):this.addLayer(t),this}getBaseLayer(){return this._baseLayer}addControl(t){if(!(t instanceof Control))throw new Error("Argument must be an instance of Control");return this._controls.push(t),t.addTo(this),this}removeControl(t){const e=this._controls.indexOf(t);return-1!==e&&(this._controls.splice(e,1),t.remove()),this}getControls(){return[...this._controls]}addHandler(t,e){return this._handlers[t]||(this._handlers[t]=new e(this),this._handlers[t].enable()),this}removeHandler(t){const e=this._handlers[t];return e&&(e.destroy(),delete this._handlers[t]),this}getHandler(t){return this._handlers[t]||null}enableHandler(t){const e=this.getHandler(t);return e&&e.enable(),this}disableHandler(t){const e=this.getHandler(t);return e&&e.disable(),this}getHandlers(){return{...this._handlers}}setZoom(t){const e=this._baseLayer?.getMinZoom()??0,a=this._baseLayer?.getMaxZoom()??18,n=Math.max(e,Math.min(a,t));n!==this.zoom&&(this.zoom=n,this.render(),this.showZoomOverlay(),this.updateControlsUI(),this.fire("zoom"))}setBearing(t){const e=normalizeAngle(t);Math.abs(e-this.bearing)<1e-6||(this.bearing=e,this.render(),this.fire("rotate"))}showZoomOverlay(){this.zoomOverlay&&(this.zoomOverlay.textContent=`Zoom: ${this.zoom.toFixed(2)}`,this.zoomOverlay.style.opacity=1,clearTimeout(this._zTimer),this._zTimer=setTimeout((()=>{this.zoomOverlay.style.opacity=0}),500))}stopInertia(){this._inertiaRAF&&(cancelAnimationFrame(this._inertiaRAF),this._inertiaRAF=null)}stopAnimations(){this.stopInertia(),this._zoomAnim?.raf&&(cancelAnimationFrame(this._zoomAnim.raf),this._zoomAnim=null),this._flyAnim?.raf&&(cancelAnimationFrame(this._flyAnim.raf),this._flyAnim=null)}resize(){const t=this.container.offsetWidth,e=this.container.offsetHeight;this.dpr=window.devicePixelRatio||1,this.canvas.width=t*this.dpr,this.canvas.height=e*this.dpr,this.canvas.style.width=`${t}px`,this.canvas.style.height=`${e}px`,this.ctx.setTransform(this.dpr,0,0,this.dpr,0,0),this.render(),this.fire("resize")}scheduleRender(){this.renderScheduled||(this.renderScheduled=!0,requestAnimationFrame((()=>{this.renderScheduled=!1,this._draw()})))}render(){this.scheduleRender()}_snapCanvasToPixelGrid(){const t=this.ctx.getTransform(),e=t.e*this.dpr,a=t.f*this.dpr,n=-(e%1)/this.dpr,o=-(a%1)/this.dpr;this.ctx.translate(n,o)}_draw(){const t=this._baseLayer?.getBackground()??"#000",e=this.canvas.width/this.dpr,a=this.canvas.height/this.dpr;this.ctx.fillStyle=t,this.ctx.fillRect(0,0,e,a);for(const t of this._layers)t.render();this._snapCanvasToPixelGrid();const n=this._baseLayer instanceof TileLayer?this._baseLayer.loadingTiles.size:0;this.loadingEl?.classList.toggle("visible",n>0),this.loadingCountEl&&(this.loadingCountEl.textContent=n),this.coordsEl&&(this.coordsEl.textContent=`${this.center.lat.toFixed(6)}°, ${this.center.lon.toFixed(6)}° | Z: ${this.zoom.toFixed(2)} | Bearing: ${(this.bearing*RAD2DEG).toFixed(1)}°`),this.updateControlsUI(),this.fire("moveend")}updateAttribution(){for(const t of this._controls)t instanceof AttributionControl&&"function"==typeof t._update&&t._update()}updateControlsUI(){for(const t of this._controls)"function"==typeof t._update&&t._update()}getCenter(){return{...this.center}}getZoom(){return this.zoom}getBearing(){return this.bearing}screenToLatLon(t,e,a=this.zoom,n=this.bearing,o=this.center){const i=this.canvas.width/this.dpr,s=this.canvas.height/this.dpr,r=Math.floor(a),l=TILE_SIZE*Math.pow(2,a-r),d=this.projection.latLngToTile(o,r),h={x:t-i/2,y:e-s/2},c=rot(h.x/l,h.y/l,-n),u={x:d.x+c.x,y:d.y+c.y},m=this.projection.tileToLatLng(u.x,u.y,r);return{lon:GISUtils.wrapLongitude(m.lon),lat:GISUtils.clampLatitude(m.lat)}}latLngToContainerPoint(t){const e=this.canvas.width/this.dpr,a=this.canvas.height/this.dpr,n=Math.floor(this.zoom),o=TILE_SIZE*Math.pow(2,this.zoom-n),i=this.projection.latLngToTile(this.center,n),s=this.projection.latLngToTile(t,n),r=(s.x-i.x)*o,l=(s.y-i.y)*o,d=rot(r,l,this.bearing);return{x:e/2+d.x,y:a/2+d.y}}applyZoomRotateAbout(t,e,a,n=this.bearing,o=null){const i=this._baseLayer?.getMinZoom()??0,s=this._baseLayer?.getMaxZoom()??18;a=Math.max(i,Math.min(s,a));const r=this.canvas.width/this.dpr,l=this.canvas.height/this.dpr,d={x:t-r/2,y:e-l/2},h=o||this.screenToLatLon(t,e,this.zoom,this.bearing,this.center),c=Math.floor(a),u=TILE_SIZE*Math.pow(2,a-c),m=this.projection.latLngToTile(h,c),g=rot(d.x/u,d.y/u,-n),p={x:m.x-g.x,y:m.y-g.y},v=this.projection.tileToLatLng(p.x,p.y,c);this.center={lon:GISUtils.wrapLongitude(v.lon),lat:GISUtils.clampLatitude(v.lat)},this.zoom=a,this.bearing=normalizeAngle(n)}showZoomIndicator(t,e){this._zoomIndicator&&this.container.removeChild(this._zoomIndicator);const a=document.createElement("div");a.style.position="absolute",a.style.left=`${t-15}px`,a.style.top=`${e-15}px`,a.style.width="30px",a.style.height="30px",a.style.borderRadius="50%",a.style.border="2px solid #333",a.style.opacity=".8",a.style.pointerEvents="none",a.style.zIndex="100",a.style.animation="zoom-indicator .6s ease-out forwards",this.container.appendChild(a),this._zoomIndicator=a,setTimeout((()=>{this._zoomIndicator?.parentNode&&(this.container.removeChild(this._zoomIndicator),this._zoomIndicator=null)}),600)}animateZoomRotateAbout(t,e,a,n=this.bearing,o=WHEEL_ZOOM_DURATION,i=EASING.easeInOutCubic){this.showZoomIndicator(t,e),this.stopAnimations();const s=performance.now(),r=this.zoom,l=this.bearing,d=shortestAngleDiff(l,n),h=this.screenToLatLon(t,e,this.zoom,this.bearing,this.center),c=()=>{const n=(performance.now()-s)/Math.max(1,o),u=n>=1?1:i(Math.max(0,Math.min(1,n))),m=r+(a-r)*u,g=l+d*u;this.applyZoomRotateAbout(t,e,m,g,h),this.render(),n<1?(this._zoomAnim={raf:requestAnimationFrame(c)}):(this._zoomAnim=null,this.updateControlsUI(),this.fire("zoomend"))};this._zoomAnim={raf:requestAnimationFrame(c)},this.fire("zoomstart")}smoothZoomAt(t,e,a){const n=this._baseLayer?.getMinZoom()??0,o=this._baseLayer?.getMaxZoom()??18,i=Math.max(n,Math.min(o,this.zoom+a));this.animateZoomRotateAbout(t,e,i,this.bearing,WHEEL_ZOOM_DURATION,EASING.easeInOutCubic)}flyTo({center:t=this.center,zoom:e=this.zoom,bearing:a=this.bearing,duration:n=FLYTO_DURATION,easing:o=EASING.easeInOutCubic}={}){const i=this._baseLayer?.getMinZoom()??0,s=this._baseLayer?.getMaxZoom()??18,r=Math.max(i,Math.min(s,e));this.stopAnimations();const l=performance.now(),d={...this.center},h={...t},c=wrapDeltaLon(h.lon-d.lon),u=h.lat-d.lat,m=this.zoom,g=r,p=this.bearing,v=shortestAngleDiff(p,a),y=()=>{const t=(performance.now()-l)/Math.max(1,n),e=t>=1?1:o(Math.max(0,Math.min(1,t)));this.center={lon:GISUtils.wrapLongitude(d.lon+c*e),lat:GISUtils.clampLatitude(d.lat+u*e)},this.zoom=m+(g-m)*e,this.bearing=normalizeAngle(p+v*e),this.render(),t<1?(this._flyAnim={raf:requestAnimationFrame(y)}):(this._flyAnim=null,this.updateControlsUI(),this.fire("moveend"))};this._flyAnim={raf:requestAnimationFrame(y)},this.fire("movestart")}destroy(){this.stopAnimations();for(const t of[...this._layers])this.removeLayer(t);for(const t of[...this._controls])this.removeControl(t);for(const t in this._controlCorners){const e=this._controlCorners[t];e?.parentNode&&e.parentNode.removeChild(e)}this._controlCorners={};for(const t in this._handlers)this.removeHandler(t);this.fire("unload")}}
let atlasInstance=null;function initializeAtlas(){const t=t=>{console.warn("[Atlas] Geolocation failed:",t?.message||t),e()},e=()=>{atlasInstance=new Atlas("map");const t=LAYERS[CONFIG.defaultLayer];if(!t)return;const e="ESRI"===CONFIG.defaultLayer?"https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}":`${t.tileServers[0]}/{z}/{x}/{y}.png`,a=new TileLayer(e,{minZoom:t.minZoom,maxZoom:t.maxZoom,attribution:t.attribution,background:t.background,supportsRetina:t.supportsRetina,maxCacheSize:t.maxCacheSize});atlasInstance.setBaseLayer(a)};navigator.geolocation?navigator.geolocation.getCurrentPosition((n=>{atlasInstance=new Atlas("map");const o=n.coords.latitude,i=n.coords.longitude;atlasInstance.flyTo({center:{lat:o,lon:i},zoom:10});const s=LAYERS[CONFIG.defaultLayer],r="ESRI"===CONFIG.defaultLayer?"https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}":`${s.tileServers[0]}/{z}/{x}/{y}.png`,l=new TileLayer(r,{minZoom:s.minZoom,maxZoom:s.maxZoom,attribution:s.attribution,background:s.background,supportsRetina:s.supportsRetina,maxCacheSize:s.maxCacheSize});atlasInstance.setBaseLayer(l);const d=new GeoJSONLayer({type:"FeatureCollection",features:[{type:"Feature",geometry:{type:"Point",coordinates:[i,o]},properties:{name:"You Are Here (GeoJSON)"}}]},{style:{radius:8,fillColor:"#ff7800",color:"#fff",weight:2},interactive:!0});atlasInstance.addLayer(d)}),t,{enableHighAccuracy:!0,timeout:1e4,maximumAge:0}):(console.warn("[Atlas] Geolocation is not supported by this browser."),e())} "loading"===document.readyState?document.addEventListener("DOMContentLoaded",initializeAtlas):initializeAtlas();
</script></body></html>
